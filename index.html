<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prism Hold - Luxury Accessories</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Razorpay Checkout -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        html { scroll-behavior: smooth; overscroll-behavior-y: none; }
        :root { 
            --color-primary: #1a1a1a; 
            --color-secondary: #ffffff; 
            --color-accent: #c5a065; 
            --color-accent-light: #e0cba8; 
            --color-bg: #fafafa;
            --color-gray-50: #f9fafb;
            --color-gray-100: #f3f4f6;
            --color-gray-200: #e5e7eb;
            --color-gray-300: #d1d5db;
            --color-gray-400: #9ca3af;
            --color-gray-500: #6b7280;
            --color-gray-600: #4b5563;
            --color-gray-700: #374151;
            --color-gray-800: #1f2937;
            --color-gray-900: #111827;
        }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background-color: var(--color-bg); 
            color: var(--color-primary); 
            -webkit-tap-highlight-color: transparent; 
            padding-bottom: 0; 
            overscroll-behavior-y: none;
            font-feature-settings: 'kern' 1;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; } 
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; } 
        .custom-scroll::-webkit-scrollbar { width: 6px; } 
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; } 
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Enhanced Buttons */
        .luxury-button { 
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); 
            color: white; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.08); 
            position: relative;
            overflow: hidden;
        }
        .luxury-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        .luxury-button:hover::before {
            left: 100%;
        }
        .luxury-button:active { transform: scale(0.97); } 
        .luxury-button:hover { 
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%); 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2), 0 4px 8px rgba(0, 0, 0, 0.1); 
            transform: translateY(-2px); 
        }
        .luxury-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .accent-button { 
            background: linear-gradient(135deg, #c5a065 0%, #b8945a 100%); 
            color: white; 
            box-shadow: 0 4px 15px rgba(197, 160, 101, 0.35), 0 2px 4px rgba(197, 160, 101, 0.2); 
            position: relative;
            overflow: hidden;
        }
        .accent-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .accent-button:hover::before {
            left: 100%;
        }
        .accent-button:hover { 
            background: linear-gradient(135deg, #d4af76 0%, #c5a065 100%); 
            box-shadow: 0 8px 25px rgba(197, 160, 101, 0.5), 0 4px 8px rgba(197, 160, 101, 0.3); 
            transform: translateY(-2px);
        }
        .accent-button:active { transform: scale(0.97) translateY(0); }
        .accent-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Modal Transitions */
        #cart-modal, #mobile-menu { 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        } 
        #cart-modal.open { transform: translateX(0); } 
        #mobile-menu.open { transform: translateX(0); }
        
        /* Hero Section */
        .hero-bg { 
            background-image: url('image.png'); 
            background-size: cover; 
            background-position: center; 
            position: relative;
        }
        .hero-bg::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.1) 100%);
        }
        
        /* Enhanced Product Cards */
        .product-card-modern { 
            background: white; 
            border-radius: 16px; 
            overflow: hidden; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 1px solid rgba(0, 0, 0, 0.06);
            position: relative;
        }
        .product-card-modern::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 16px;
            padding: 1px;
            background: linear-gradient(135deg, transparent, rgba(197, 160, 101, 0.1), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.4s;
        }
        .product-card-modern:hover::after {
            opacity: 1;
        }
        .product-card-modern:hover { 
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12), 0 8px 16px rgba(0, 0, 0, 0.08); 
            transform: translateY(-6px) scale(1.01); 
            border-color: rgba(197, 160, 101, 0.2);
        }
        .product-image-wrapper { 
            overflow: hidden; 
            position: relative; 
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        }
        .product-image { 
            transition: transform 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        .product-card-modern:hover .product-image { 
            transform: scale(1.1); 
        }
        
        /* Category Buttons */
        .category-btn { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .category-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 9999px;
            background: var(--color-primary);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .category-btn.active { 
            background-color: var(--color-primary); 
            color: white; 
            border-color: var(--color-primary); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1); 
            transform: translateY(-1px);
        }
        .category-btn:hover:not(.active) {
            border-color: var(--color-accent);
            color: var(--color-accent);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(197, 160, 101, 0.15);
        }
        
        .account-tab-btn.active { 
            background-color: var(--color-primary); 
            color: var(--color-secondary); 
            border-color: var(--color-primary); 
        }
        
        /* Enhanced Animations */
        @keyframes scale-in { 
            from { transform: scale(0.95); opacity: 0; } 
            to { transform: scale(1); opacity: 1; } 
        }
        .animate-scale-in { 
            animation: scale-in 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes checkmark { 
            0% { transform: scale(0) rotate(-45deg); } 
            50% { transform: scale(1.2) rotate(0deg); } 
            100% { transform: scale(1) rotate(0deg); } 
        }
        .animate-checkmark { 
            animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        @keyframes slide-in-right { 
            from { transform: translateX(120%); opacity: 0; } 
            to { transform: translateX(0); opacity: 1; } 
        }
        @keyframes slide-out-right { 
            from { transform: translateX(0); opacity: 1; } 
            to { transform: translateX(120%); opacity: 0; } 
        }
        @keyframes bounce-in { 
            0% { transform: scale(0) rotate(-180deg); } 
            50% { transform: scale(1.15) rotate(0deg); } 
            100% { transform: scale(1) rotate(0deg); } 
        }
        .product-added-notification { 
            animation: slide-in-right 0.5s cubic-bezier(0.4, 0, 0.2, 1), slide-out-right 0.4s cubic-bezier(0.4, 0, 0.2, 1) 2.5s forwards; 
        }
        .product-added-icon { 
            animation: bounce-in 0.6s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        /* Enhanced Input Fields */
        input[type="text"], input[type="email"], input[type="password"], input[type="tel"] {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, input[type="tel"]:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(197, 160, 101, 0.15), 0 0 0 3px rgba(197, 160, 101, 0.1);
        }
        
        /* Loading Skeleton */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 2000px 100%;
            animation: shimmer 2s infinite;
        }
        
        /* Enhanced Scroll to Top */
        #scroll-to-top {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #scroll-to-top:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 24px rgba(197, 160, 101, 0.4);
        }
        
        /* Better Header */
        header {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Enhanced Empty States */
        .empty-state {
            padding: 3rem 1rem;
            text-align: center;
        }
        .empty-state-icon {
            opacity: 0.3;
            margin-bottom: 1rem;
        }
        
        /* Improved Mobile Bottom Nav */
        .mobile-nav-item {
            transition: all 0.2s;
        }
        .mobile-nav-item:active {
            transform: scale(0.9);
        }
        
        /* Better Focus States */
        *:focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
        }
        
        /* Smooth Image Loading */
        img {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        
        /* Enhanced Card Hover Effects */
        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }
    </style>
    <script>
        tailwind.config = { theme: { extend: { colors: { 'primary': '#1a1a1a', 'secondary': '#ffffff', 'accent': '#c5a065', 'accent-light': '#e0cba8', 'bg-main': '#f9f9f9' }, screens: { 'xs': '475px' } } } }
    </script>
</head>
<body class="min-h-screen bg-bg-main text-primary">

    <!-- MongoDB API Client -->
    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:3000/api';
        
        // Helper function to get auth token
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }
        
        // Helper function to set auth token
        function setAuthToken(token) {
            if (token) {
                localStorage.setItem('authToken', token);
            } else {
                localStorage.removeItem('authToken');
            }
        }
        
        // Helper function to get current user
        function getCurrentUser() {
            const userStr = localStorage.getItem('currentUser');
            return userStr ? JSON.parse(userStr) : null;
        }
        
        // Helper function to set current user
        function setCurrentUser(user) {
            if (user) {
                localStorage.setItem('currentUser', JSON.stringify(user));
            } else {
                localStorage.removeItem('currentUser');
            }
        }
        
        // API Request Helper
        async function apiRequest(endpoint, options = {}) {
            const token = getAuthToken();
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    ...options,
                    headers
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ error: 'Request failed' }));
                    throw new Error(error.error || 'Request failed');
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Request Error:', error);
                throw error;
            }
        }
        
        let categories = [];
        let topCategories = [];

        // Load categories from API
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE_URL}/categories`);
                if (response.ok) {
                    categories = await response.json();
                    renderCategoriesPage();
                }
                
                // Load top 3 most ordered categories
                const topResponse = await fetch(`${API_BASE_URL}/categories/most-ordered`);
                if (topResponse.ok) {
                    topCategories = await topResponse.json();
                    renderCategoryButtons();
                } else {
                    // Fallback: use first 3 categories
                    topCategories = categories.slice(0, 3);
                    renderCategoryButtons();
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        // Render categories page
        function renderCategoriesPage() {
            const container = document.getElementById('categories-grid');
            if (!container) return;
            
            container.innerHTML = categories.length ? categories.map(cat => {
                const coverImage = cat.coverImage || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 400 400\'%3E%3Crect fill=\'%23f3f4f6\' width=\'400\' height=\'400\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' font-family=\'sans-serif\' font-size=\'18\' fill=\'%239ca3af\'%3E${cat.name}%3C/text%3E%3C/svg%3E';
                return `
                    <div class="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer group" onclick="setCategory('${cat.name}'); document.getElementById('shop').scrollIntoView({ behavior: 'smooth' });">
                        <div class="aspect-[4/3] bg-gray-100 relative overflow-hidden">
                            <img src="${coverImage}" alt="${cat.name}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                            <div class="absolute bottom-0 left-0 right-0 p-6 text-white transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
                                <h3 class="text-2xl font-bold mb-2">${cat.name}</h3>
                                <p class="text-sm text-white/90 line-clamp-2">${cat.description || 'Explore our collection'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') : '<p class="col-span-full text-center text-gray-500 py-8">No categories available</p>';
        }
        
        // Load and render new products
        async function loadNewProducts() {
            const container = document.getElementById('new-products-list');
            if (!container) return;
            
            try {
                // Get recently added products (sorted by createdAt, newest first)
                const newProducts = [...products].sort((a, b) => {
                    const dateA = new Date(a.createdAt || 0);
                    const dateB = new Date(b.createdAt || 0);
                    return dateB - dateA;
                }).slice(0, 8); // Show 8 most recent
                
                container.innerHTML = newProducts.length ? newProducts.map(p => {
                    const productImage = (p.images && p.images.length > 0) ? p.images[0] : (p.image || '');
                    return `
                        <div class="bg-white rounded-2xl overflow-hidden product-card-modern group cursor-pointer" onclick="openProductDetail(${p.id})">
                            <div class="product-image-wrapper aspect-square bg-gray-100 relative">
                                <img src="${productImage}" class="product-image" loading="lazy" alt="${p.name}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 400 400\\'%3E%3Crect fill=\\'%23f3f4f6\\' width=\\'400\\' height=\\'400\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' font-family=\\'sans-serif\\' font-size=\\'18\\' fill=\\'%239ca3af\\'%3EImage%3C/text%3E%3C/svg%3E'">
                                <button onclick="event.stopPropagation(); addToCart(${p.id})" class="absolute bottom-4 right-4 bg-white/95 backdrop-blur-md text-primary w-11 h-11 rounded-full flex items-center justify-center shadow-xl transform translate-y-12 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-400 hover:bg-primary hover:text-white hover:scale-110 active:scale-95 z-10">
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="p-5">
                                <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">${p.category}</p>
                                <h3 class="text-sm font-bold text-gray-900 line-clamp-1 mb-1">${p.name}</h3>
                                <div class="flex items-center space-x-2">
                                    ${p.discount ? `
                                        <span class="text-base font-bold text-accent">${formatCurrency(p.price * (1 - p.discount / 100))}</span>
                                        <span class="text-xs text-gray-400 line-through">${formatCurrency(p.price)}</span>
                                        <span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded">-${p.discount}%</span>
                                    ` : `<p class="text-base font-bold text-accent">${formatCurrency(p.price)}</p>`}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('') : '<p class="col-span-full text-center text-gray-500 py-8">No new products available</p>';
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading new products:', error);
            }
        }

        // Render category buttons
        function renderCategoryButtons() {
            const container = document.getElementById('category-buttons-container');
            if (!container) return;
            
            let html = `<button onclick="setCategory('all')" data-cat="all" class="category-btn active px-6 py-2.5 rounded-full border-2 border-gray-200 text-xs font-bold transition-all duration-300 whitespace-nowrap shadow-sm">ALL</button>`;
            
            // Show top 3 categories
            topCategories.slice(0, 3).forEach(cat => {
                html += `<button onclick="setCategory('${cat.name}')" data-cat="${cat.name}" class="category-btn px-6 py-2.5 rounded-full bg-white border-2 border-gray-200 text-gray-600 hover:border-accent hover:text-accent text-xs font-bold transition-all duration-300 whitespace-nowrap shadow-sm">${cat.name.toUpperCase()}</button>`;
            });
            
            // Add "View All" button if there are more categories
            if (categories.length > 3) {
                html += `<button onclick="showAllCategories()" class="px-6 py-2.5 rounded-full bg-accent text-white border-2 border-accent text-xs font-bold transition-all duration-300 whitespace-nowrap shadow-sm hover:bg-accent/90">VIEW ALL</button>`;
            }
            
            container.innerHTML = html;
            lucide.createIcons();
        }

        function showAllCategories() {
            const container = document.getElementById('category-buttons-container');
            let html = `<button onclick="setCategory('all')" data-cat="all" class="category-btn active px-6 py-2.5 rounded-full border-2 border-gray-200 text-xs font-bold transition-all duration-300 whitespace-nowrap shadow-sm">ALL</button>`;
            
            categories.forEach(cat => {
                html += `<button onclick="setCategory('${cat.name}')" data-cat="${cat.name}" class="category-btn px-6 py-2.5 rounded-full bg-white border-2 border-gray-200 text-gray-600 hover:border-accent hover:text-accent text-xs font-bold transition-all duration-300 whitespace-nowrap shadow-sm">${cat.name.toUpperCase()}</button>`;
            });
            
            container.innerHTML = html;
            lucide.createIcons();
        }

        // Load products from API
        async function loadProducts() {
            try {
                const response = await fetch(`${API_BASE_URL}/products`);
                if (response.ok) {
                    products = await response.json();
                    // Convert MongoDB _id to id for compatibility
                    products = products.map(p => ({
                        ...p,
                        id: p.id || p._id
                    }));
                    filterProducts();
                    loadCategorySections();
                    loadRecommendations();
                    loadNewProducts();
                } else {
                    console.error('Failed to load products');
                }
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Load category-wise sections
        async function loadCategorySections() {
            const container = document.getElementById('category-sections-container');
            if (!container) return;
            
            const uniqueCategories = [...new Set(products.map(p => p.category).filter(Boolean))];
            let html = '';
            
            for (const category of uniqueCategories) {
                const categoryProducts = products.filter(p => p.category === category).slice(0, 8);
                if (categoryProducts.length === 0) continue;
                
                html += `
                    <section class="category-section max-w-7xl mx-auto py-16 md:py-20 px-4 sm:px-6 lg:px-8" data-category="${category}">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl md:text-5xl font-light text-primary tracking-tight">${category}</h2>
                            <button onclick="setCategory('${category}')" class="text-sm text-accent hover:underline font-medium">View All →</button>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-5 md:gap-6 lg:gap-8">
                            ${categoryProducts.map(p => {
                                const productImage = (p.images && p.images.length > 0) ? p.images[0] : (p.image || '');
                                return `
                                <div class="bg-white rounded-2xl overflow-hidden product-card-modern group cursor-pointer" onclick="openProductDetail(${p.id})">
                                    <div class="product-image-wrapper aspect-square bg-gray-100 relative">
                                        <img src="${productImage}" class="product-image" loading="lazy" alt="${p.name}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 400 400\\'%3E%3Crect fill=\\'%23f3f4f6\\' width=\\'400\\' height=\\'400\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' font-family=\\'sans-serif\\' font-size=\\'18\\' fill=\\'%239ca3af\\'%3EImage%3C/text%3E%3C/svg%3E'">
                                        <button onclick="event.stopPropagation(); addToCart(${p.id})" class="absolute bottom-4 right-4 bg-white/95 backdrop-blur-md text-primary w-11 h-11 rounded-full flex items-center justify-center shadow-xl transform translate-y-12 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-400 hover:bg-primary hover:text-white hover:scale-110 active:scale-95 z-10">
                                            <i data-lucide="plus" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                    <div class="p-5">
                                        <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">${p.category}</p>
                                        <h3 class="text-sm font-bold text-gray-900 line-clamp-1 mb-1">${p.name}</h3>
                                        <div class="flex items-center space-x-2">
                                            ${p.discount ? `
                                                <span class="text-base font-bold text-accent">${formatCurrency(p.price * (1 - p.discount / 100))}</span>
                                                <span class="text-xs text-gray-400 line-through">${formatCurrency(p.price)}</span>
                                                <span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded">-${p.discount}%</span>
                                            ` : `<p class="text-base font-bold text-accent">${formatCurrency(p.price)}</p>`}
                                        </div>
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                    </section>
                `;
            }
            
            container.innerHTML = html;
            lucide.createIcons();
            setupScrollAnimations();
        }

        // Load recommendations
        async function loadRecommendations() {
            const container = document.getElementById('recommendations-list');
            if (!container) return;
            
            try {
                const token = getAuthToken();
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                
                const response = await fetch(`${API_BASE_URL}/products/recommendations`, { headers });
                if (response.ok) {
                    const recommendations = await response.json();
                    if (recommendations.length > 0) {
                        container.innerHTML = recommendations.map(p => {
                            const productImage = (p.images && p.images.length > 0) ? p.images[0] : (p.image || '');
                            return `
                            <div class="bg-white rounded-2xl overflow-hidden product-card-modern group cursor-pointer" onclick="openProductDetail(${p.id})">
                                <div class="product-image-wrapper aspect-square bg-gray-100 relative">
                                    <img src="${productImage}" class="product-image" loading="lazy" alt="${p.name}">
                                    <button onclick="event.stopPropagation(); addToCart(${p.id})" class="absolute bottom-4 right-4 bg-white/95 backdrop-blur-md text-primary w-11 h-11 rounded-full flex items-center justify-center shadow-xl transform translate-y-12 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-400 hover:bg-primary hover:text-white">
                                        <i data-lucide="plus" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                <div class="p-5">
                                    <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">${p.category}</p>
                                    <h3 class="text-sm font-bold text-gray-900 line-clamp-1 mb-1">${p.name}</h3>
                                    <div class="flex items-center space-x-2">
                                        ${p.discount ? `
                                            <span class="text-base font-bold text-accent">${formatCurrency(p.price * (1 - p.discount / 100))}</span>
                                            <span class="text-xs text-gray-400 line-through">${formatCurrency(p.price)}</span>
                                        ` : `<p class="text-base font-bold text-accent">${formatCurrency(p.price)}</p>`}
                                    </div>
                                </div>
                            </div>
                        `;
                        }).join('');
                        lucide.createIcons();
                    } else {
                        container.innerHTML = '<p class="col-span-full text-center text-gray-400">No recommendations available</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading recommendations:', error);
            }
        }

        // Setup scroll animations for category sections
        function setupScrollAnimations() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animate-fade-in-up');
                    }
                });
            }, { threshold: 0.1 });
            
            document.querySelectorAll('.category-section').forEach(section => {
                observer.observe(section);
            });
        }
        
        // Initialize app - check for existing auth
        window.initApp = async function() {
            await loadCategories(); // Load categories first
            await loadProducts(); // Load products
            const token = getAuthToken();
            const user = getCurrentUser();
            
            if (token && user) {
                        window.currentUser = user;
                        window.updateAuthUI(true);
                        window.initUserDataListeners(user.uid);
                    } else {
                        window.currentUser = null;
                        window.updateAuthUI(false);
                    }
        };
        
        // Initialize on load
        window.initApp();
    </script>

    <!-- Main Navigation Bar -->
    <header class="bg-white/98 backdrop-blur-xl shadow-sm sticky top-0 z-30 transition-all duration-300 border-b border-gray-100/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center py-4">
            <button onclick="toggleMobileMenu()" class="md:hidden p-2.5 -ml-2 text-primary hover:bg-gray-100 rounded-full transition-all duration-200 active:scale-95" aria-label="Menu"><i data-lucide="menu" class="w-6 h-6"></i></button>
            <a href="#home" class="text-2xl font-light tracking-[0.2em] text-primary hover:text-accent transition-all duration-300 text-center flex-grow md:flex-grow-0 cursor-pointer select-none hover:tracking-[0.25em]">PRISM HOLD</a>
            <nav class="hidden md:flex space-x-8 text-xs font-semibold tracking-widest text-gray-500">
                <a href="#home" class="hover:text-primary transition-all duration-200 relative group">
                    HOME
                    <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-accent transition-all duration-300 group-hover:w-full"></span>
                </a>
                <a href="#categories" class="hover:text-primary transition-all duration-200 relative group">
                    CATEGORIES
                    <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-accent transition-all duration-300 group-hover:w-full"></span>
                </a>
                <a href="#new" class="hover:text-primary transition-all duration-200 relative group">
                    NEW
                    <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-accent transition-all duration-300 group-hover:w-full"></span>
                </a>
                <button onclick="openContactModal()" class="hover:text-primary transition-all duration-200 relative group">
                    CONTACT US
                    <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-accent transition-all duration-300 group-hover:w-full"></span>
                </button>
            </nav>
            <div class="hidden md:flex items-center space-x-6">
                <div id="auth-buttons-desktop"></div>
                <button onclick="toggleCart()" class="relative p-2.5 rounded-full hover:bg-gray-100 transition-all duration-200 group active:scale-95" aria-label="Shopping Cart">
                    <i data-lucide="shopping-bag" class="w-5 h-5 text-primary group-hover:text-accent transition-colors"></i>
                    <span id="cart-count-desktop" class="absolute top-0 right-0 inline-flex items-center justify-center min-w-[18px] h-[18px] px-1 text-[10px] font-bold leading-none text-white bg-accent rounded-full shadow-lg ring-2 ring-white">0</span>
                </button>
            </div>
            <button onclick="toggleCart()" class="md:hidden relative p-2.5 -mr-2 text-primary hover:bg-gray-100 rounded-full transition-all duration-200 active:scale-95" aria-label="Shopping Cart">
                <i data-lucide="shopping-bag" class="w-6 h-6"></i>
                <span id="cart-count-mobile" class="absolute top-1 right-0 inline-flex items-center justify-center min-w-[18px] h-[18px] px-1 text-[10px] font-bold text-white bg-accent rounded-full border-2 border-white shadow-lg">0</span>
            </button>
        </div>
    </header>

    <!-- Mobile Bottom Nav -->
    <div class="md:hidden fixed bottom-0 left-0 w-full bg-white/98 backdrop-blur-xl border-t border-gray-100 z-40 pb-safe flex justify-around items-center py-3 shadow-[0_-8px_30px_rgba(0,0,0,0.08)]">
        <a href="#home" class="mobile-nav-item flex flex-col items-center text-gray-400 hover:text-primary transition-all duration-200 group active:scale-95">
            <i data-lucide="home" class="w-6 h-6 mb-1 group-hover:scale-110 transition-transform"></i>
            <span class="text-[10px] font-medium">Home</span>
        </a>
        <a href="#shop" class="mobile-nav-item flex flex-col items-center text-gray-400 hover:text-primary transition-all duration-200 group active:scale-95">
            <i data-lucide="search" class="w-6 h-6 mb-1 group-hover:scale-110 transition-transform"></i>
            <span class="text-[10px] font-medium">Shop</span>
        </a>
        <button onclick="toggleCart()" class="mobile-nav-item flex flex-col items-center text-gray-400 hover:text-primary transition-all duration-200 group relative active:scale-95">
            <i data-lucide="shopping-bag" class="w-6 h-6 mb-1 group-hover:scale-110 transition-transform"></i>
            <span class="text-[10px] font-medium">Cart</span>
            <span id="cart-count-bottom" class="absolute top-0 right-3 w-2.5 h-2.5 bg-accent rounded-full hidden animate-pulse shadow-lg ring-2 ring-white"></span>
        </button>
        <button onclick="handleMobileProfileClick()" class="mobile-nav-item flex flex-col items-center text-gray-400 hover:text-primary transition-all duration-200 group active:scale-95">
            <i data-lucide="user" class="w-6 h-6 mb-1 group-hover:scale-110 transition-transform"></i>
            <span class="text-[10px] font-medium">Profile</span>
        </button>
    </div>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="fixed inset-0 z-50 transform -translate-x-full transition-transform duration-300 md:hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="toggleMobileMenu()"></div>
        <div class="absolute inset-y-0 left-0 w-4/5 max-w-xs bg-white shadow-2xl flex flex-col h-full">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center"><span class="text-lg font-bold tracking-widest text-primary">MENU</span><button onclick="toggleMobileMenu()" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <nav class="flex-grow p-6 space-y-6 text-lg font-medium text-gray-800">
                <a href="#home" onclick="toggleMobileMenu()" class="flex items-center space-x-4 hover:text-accent transition-colors"><i data-lucide="home" class="w-5 h-5"></i><span>Home</span></a>
                <a href="#shop" onclick="toggleMobileMenu()" class="flex items-center space-x-4 hover:text-accent transition-colors"><i data-lucide="grid" class="w-5 h-5"></i><span>Shop All</span></a>
                <div class="border-t border-gray-100 pt-6 mt-6"><button onclick="openContactModal()" class="flex items-center space-x-3 text-primary font-medium p-3 bg-gray-50 hover:bg-gray-100 rounded-xl w-full transition"><i data-lucide="message-circle" class="w-5 h-5"></i><span>Contact Us</span></button></div>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="min-h-screen pb-24">
        <section id="home" class="hero-bg h-[550px] md:h-[700px] flex items-center justify-center text-center px-4 relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-b from-black/40 via-black/20 to-transparent"></div>
            <div class="p-8 md:p-12 bg-white/90 backdrop-blur-xl max-w-3xl mx-auto shadow-2xl rounded-3xl relative z-10 animate-fade-in-up border border-white/20">
                <h2 class="text-4xl md:text-7xl font-thin tracking-wider text-primary mb-4 leading-tight">The Art of Accessory.</h2>
                <p class="text-sm md:text-xl text-gray-700 mb-10 font-light tracking-wide leading-relaxed">HOLD Luxury in your HAND. Curated collections.</p>
                <button class="px-12 py-4.5 rounded-full text-sm font-bold tracking-widest uppercase luxury-button transform transition-all duration-300 hover:-translate-y-1 shadow-lg" onclick="document.getElementById('shop').scrollIntoView({ behavior: 'smooth' });">
                    <span class="relative z-10">Discover Collection</span>
                </button>
            </div>
        </section>
        <section id="shop" class="max-w-7xl mx-auto py-16 md:py-20 px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-12 gap-6">
                <div>
                    <h2 class="text-3xl md:text-5xl font-light text-primary mb-3 tracking-tight">Signature Collections</h2>
                    <p class="text-gray-500 text-sm md:text-base">Handpicked luxury just for you</p>
                </div>
                <div id="category-buttons-container" class="flex space-x-3 overflow-x-auto no-scrollbar w-full md:w-auto pb-2 -mx-4 px-4 md:mx-0 md:px-0">
                    <!-- Categories will be loaded dynamically -->
            </div>
            </div>
            <div class="relative mb-10">
                <i data-lucide="search" class="w-5 h-5 absolute top-4 left-5 text-gray-400 pointer-events-none"></i>
                <input type="text" id="product-search" oninput="filterProducts()" placeholder="Search for luxury items..." class="w-full pl-12 pr-12 py-4 bg-white border-2 border-gray-100 rounded-2xl focus:ring-2 focus:ring-accent/20 focus:border-accent shadow-sm text-sm transition-all duration-300 placeholder:text-gray-400">
                <button onclick="document.getElementById('product-search').value = ''; filterProducts();" class="absolute top-4 right-4 text-gray-300 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-100" aria-label="Clear search">
                    <i data-lucide="x-circle" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-5 md:gap-6 lg:gap-8"></div>
        </section>

        <!-- Categories Section -->
        <section id="categories" class="max-w-7xl mx-auto py-16 md:py-20 px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl md:text-5xl font-light text-primary mb-12 tracking-tight text-center">All Categories</h2>
            <div id="categories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                <!-- Categories will be loaded here -->
            </div>
        </section>

        <!-- New Products Section -->
        <section id="new" class="max-w-7xl mx-auto py-16 md:py-20 px-4 sm:px-6 lg:px-8 bg-gray-50">
            <h2 class="text-3xl md:text-5xl font-light text-primary mb-8 tracking-tight">New Arrivals</h2>
            <p class="text-gray-500 text-sm md:text-base mb-10">Recently added products</p>
            <div id="new-products-list" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-5 md:gap-6 lg:gap-8">
                <!-- New products will be loaded here -->
            </div>
        </section>

        <!-- Recommendations Section -->
        <section id="recommendations" class="max-w-7xl mx-auto py-16 md:py-20 px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl md:text-5xl font-light text-primary mb-8 tracking-tight">Recommended For You</h2>
            <div id="recommendations-list" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-5 md:gap-6 lg:gap-8">
                <!-- Recommendations will be loaded here -->
            </div>
        </section>

        <!-- Category-wise Sections -->
        <div id="category-sections-container">
            <!-- Category sections will be dynamically added here -->
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-primary text-white mt-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 md:pt-16 pb-8 md:pb-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 md:gap-12 mb-8">
                <!-- Brand Section -->
                <div class="col-span-1">
                    <h2 class="text-2xl font-light tracking-[0.2em] mb-4">PRISM HOLD</h2>
                    <p class="text-sm text-gray-400 leading-relaxed">Luxury accessories curated for the modern lifestyle. Hold elegance in your hand.</p>
                </div>
                
                <!-- Quick Links -->
                <div>
                    <h3 class="text-sm font-bold uppercase tracking-widest mb-4 text-gray-300">Shop</h3>
                    <ul class="space-y-3 text-sm">
                        <li><a href="#shop" onclick="setCategory('all'); document.getElementById('shop').scrollIntoView({ behavior: 'smooth' });" class="hover:text-accent transition-colors">All Products</a></li>
                        <li><a href="#new" onclick="document.getElementById('new').scrollIntoView({ behavior: 'smooth' });" class="hover:text-accent transition-colors">New Arrivals</a></li>
                        <li><a href="#categories" onclick="document.getElementById('categories').scrollIntoView({ behavior: 'smooth' });" class="hover:text-accent transition-colors">Collections</a></li>
                    </ul>
                </div>
                
                <!-- Support & Policies -->
                <div>
                    <h3 class="text-sm font-bold uppercase tracking-widest mb-4 text-gray-300">Support</h3>
                    <ul class="space-y-3 text-sm">
                        <li><button onclick="openContactModal()" class="hover:text-accent transition-colors text-left">Contact Us</button></li>
                        <li><a href="https://merchant.razorpay.com/policy/QyC2sFzV2wfeCh/shipping" target="_blank" class="hover:text-accent transition-colors">Shipping Policy</a></li>
                        <li><a href="https://merchant.razorpay.com/policy/QyC2sFzV2wfeCh/refund" target="_blank" class="hover:text-accent transition-colors">Refund Policy</a></li>
                        <li><a href="https://merchant.razorpay.com/policy/QyC2sFzV2wfeCh/terms" target="_blank" class="hover:text-accent transition-colors">Terms & Conditions</a></li>
                    </ul>
                </div>
                
                <!-- Social Media & Contact -->
                <div>
                    <h3 class="text-sm font-bold uppercase tracking-widest mb-4 text-gray-300">Connect</h3>
                    <div class="flex space-x-4 mb-6">
                        <a href="https://www.instagram.com/prismhold?igsh=MXRkdmsyMWRtNmp5cg==" target="_blank" class="w-10 h-10 rounded-full bg-white/10 hover:bg-accent flex items-center justify-center transition-colors">
                            <i data-lucide="instagram" class="w-5 h-5"></i>
                        </a>
                        <a href="https://facebook.com" target="_blank" class="w-10 h-10 rounded-full bg-white/10 hover:bg-accent flex items-center justify-center transition-colors">
                            <i data-lucide="facebook" class="w-5 h-5"></i>
                        </a>
                        <a href="https://twitter.com" target="_blank" class="w-10 h-10 rounded-full bg-white/10 hover:bg-accent flex items-center justify-center transition-colors">
                            <i data-lucide="twitter" class="w-5 h-5"></i>
                        </a>
                        <button onclick="openContactModal()" class="w-10 h-10 rounded-full bg-white/10 hover:bg-accent flex items-center justify-center transition-colors">
                            <i data-lucide="message-circle" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-400">
                        <p class="mb-1">Email: support@prismhold.com</p>
                        <p>Phone: +1 (555) 123-4567</p>
                    </div>
                </div>
            </div>
            
            <!-- Bottom Bar -->
            <div class="border-t border-white/10 pt-8 flex flex-col md:flex-row justify-between items-center gap-4">
                <p class="text-xs text-gray-400 text-center md:text-left">© 2025, Prism Hold. All rights reserved.</p>
                <div class="flex items-center space-x-6 text-xs text-gray-400">
                    <a href="https://merchant.razorpay.com/policy/QyC2sFzV2wfeCh/terms" target="_blank" class="hover:text-accent transition-colors">Terms & Conditions</a>
                    <a href="https://merchant.razorpay.com/policy/QyC2sFzV2wfeCh/refund" target="_blank" class="hover:text-accent transition-colors">Refund Policy</a>
                    <a href="https://merchant.razorpay.com/policy/QyC2sFzV2wfeCh/shipping" target="_blank" class="hover:text-accent transition-colors">Shipping Policy</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scroll to Top Button -->
    <button id="scroll-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="fixed bottom-6 right-6 w-14 h-14 bg-accent hover:bg-accent/90 text-white rounded-full shadow-2xl flex items-center justify-center transition-all duration-300 opacity-0 pointer-events-none z-40 backdrop-blur-sm border-2 border-white/20" aria-label="Scroll to top">
        <i data-lucide="arrow-up" class="w-6 h-6"></i>
    </button>

    <!-- Cart Sidebar -->
    <div id="cart-modal" class="fixed inset-y-0 right-0 w-full md:w-[480px] bg-white shadow-2xl z-50 transform translate-x-full flex flex-col h-full">
        <div class="flex justify-between items-center p-6 border-b border-gray-100 bg-white/98 backdrop-blur-sm">
            <h3 class="text-xl font-bold text-primary flex items-center tracking-tight">
                <i data-lucide="shopping-bag" class="w-5 h-5 mr-2 text-accent"></i>
                Shopping Bag
            </h3>
            <button onclick="toggleCart()" class="p-2 hover:bg-gray-100 rounded-full transition-all duration-200 active:scale-95" aria-label="Close cart">
                <i data-lucide="x" class="w-6 h-6 text-gray-500"></i>
            </button>
        </div>
        <div id="cart-items-list" class="flex-grow overflow-y-auto p-6 space-y-4 bg-gray-50/50 custom-scroll"></div>
        <div class="p-6 border-t border-gray-100 bg-white/98 backdrop-blur-sm pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.08)]">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-100">
                <span class="text-gray-600 font-medium text-base">Subtotal</span>
                <span id="cart-subtotal" class="font-bold text-primary text-2xl">₹0</span>
            </div>
            <button onclick="initiateCheckout()" class="w-full accent-button font-bold py-4 rounded-xl shadow-lg transform transition-all duration-300 active:scale-95 text-sm tracking-widest uppercase">
                Proceed to Checkout
            </button>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-end md:items-center justify-center p-0 md:p-4" onclick="closeCheckoutModal(event)">
        <div class="bg-white rounded-t-2xl md:rounded-2xl shadow-2xl w-full max-w-6xl h-[95vh] md:h-[90vh] flex flex-col overflow-hidden animate-scale-in" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-6 border-b border-gray-100 bg-white/98 backdrop-blur-sm shrink-0 z-10 shadow-sm">
                <h2 class="text-xl font-bold text-primary tracking-tight flex items-center">
                    <i data-lucide="lock" class="w-5 h-5 mr-2 text-accent"></i>
                    Secure Checkout
                </h2>
                <button onclick="closeCheckoutModal(event, true)" class="p-2 hover:bg-gray-100 rounded-full transition-all duration-200 active:scale-95" aria-label="Close checkout">
                    <i data-lucide="x" class="w-6 h-6 text-gray-500"></i>
                </button>
            </div>
            <!-- Scrollable Content (Address + Payment + Summary) -->
            <div class="flex-grow overflow-y-auto p-5 md:p-8 custom-scroll bg-gray-50">
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="w-full md:w-3/5 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border-2 border-gray-100 hover:border-accent/30 transition-all duration-300">
                            <h3 class="text-sm font-bold mb-5 flex items-center text-gray-400 uppercase tracking-widest"><i data-lucide="map-pin" class="w-4 h-4 mr-2 text-accent"></i> Delivery Address</h3>
                            <div id="checkout-address-list" class="space-y-3"></div>
                            <button onclick="openAddressForm()" class="mt-4 w-full py-3.5 border-2 border-dashed border-gray-200 text-gray-500 rounded-xl hover:border-accent hover:text-accent hover:bg-accent/5 transition-all duration-300 flex justify-center items-center font-medium text-sm active:scale-95">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i> 
                                Add New Address
                            </button>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border-2 border-gray-100 hover:border-accent/30 transition-all duration-300">
                            <h3 class="text-sm font-bold mb-5 flex items-center text-gray-400 uppercase tracking-widest"><i data-lucide="credit-card" class="w-4 h-4 mr-2 text-accent"></i> Payment Method</h3>
                            <div class="grid grid-cols-1 gap-3">
                                <label class="flex items-center p-4 border-2 border-accent bg-accent/5 rounded-xl cursor-pointer transition-all duration-300">
                                    <input type="radio" name="payment_method" value="Razorpay" class="accent-accent w-5 h-5 mr-4" checked>
                                    <div class="flex items-center space-x-3">
                                        <img src="https://razorpay.com/assets/razorpay-glyph.svg" alt="Razorpay" class="h-6 w-6 object-contain">
                                        <span class="font-medium text-sm">Razorpay (UPI, Cards, NetBanking, Wallets)</span>
                                    </div>
                                </label>
                            </div>
                            <p class="text-xs text-gray-500 mt-3">Secure payment powered by Razorpay</p>
                        </div>
                    </div>
                    <div class="w-full md:w-2/5">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border-2 border-gray-100 h-full sticky top-6">
                            <h3 class="text-sm font-bold mb-6 text-gray-400 uppercase tracking-widest flex items-center">
                                <i data-lucide="receipt" class="w-4 h-4 mr-2 text-accent"></i>
                                Order Summary
                            </h3>
                            <div id="checkout-product-list" class="mb-6 space-y-4 max-h-[300px] overflow-y-auto custom-scroll"></div>
                            <div class="space-y-4 border-t border-gray-200 pt-6 text-sm">
                                <div class="flex justify-between text-gray-600 items-center">
                                    <span>Subtotal</span>
                                    <span id="checkout-subtotal" class="font-medium text-base">₹0</span>
                                </div>
                                <div class="flex justify-between text-green-600 items-center">
                                    <span>Discount</span>
                                    <span id="checkout-discount" class="font-medium text-base">₹0</span>
                                </div>
                                <div class="pt-3 border-t border-gray-100">
                                    <div class="flex space-x-2">
                                        <input type="text" id="coupon-code" placeholder="PROMO CODE" class="flex-grow p-3 bg-gray-50 border-2 border-gray-200 rounded-lg text-sm uppercase tracking-wider outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 transition-all">
                                        <button onclick="applyCoupon()" class="bg-gray-900 text-white px-5 py-3 rounded-lg text-xs font-bold hover:bg-gray-800 transition-all duration-200 active:scale-95 shadow-sm">APPLY</button>
                                    </div>
                                    <p id="coupon-message" class="text-xs mt-2 h-4 pl-1"></p>
                                </div>
                                <!-- Desktop Total (Hidden on mobile as it's in footer) -->
                                <div class="hidden md:flex justify-between text-xl font-bold border-t-2 border-gray-200 pt-4 mt-2 text-primary items-center">
                                    <span>Total</span>
                                    <span id="checkout-total" class="text-accent text-2xl">₹0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Fixed Footer Button -->
            <div class="p-6 border-t border-gray-100 bg-white/98 backdrop-blur-sm shrink-0 flex flex-col md:flex-row justify-between items-center gap-4 shadow-[0_-8px_30px_rgba(0,0,0,0.08)] z-20">
                <div class="flex justify-between w-full md:w-auto md:flex-col items-center md:items-start">
                    <span class="text-xs text-gray-400 uppercase tracking-wider font-bold mb-1">Total Amount</span>
                    <span id="checkout-total-footer" class="text-3xl font-bold text-primary">₹0</span>
                </div>
                <button onclick="placeOrder()" id="place-order-btn" class="w-full md:w-auto px-12 py-4 accent-button rounded-full font-bold shadow-lg text-sm tracking-widest uppercase transform transition-all duration-300 active:scale-95 hover:shadow-xl">
                    <span class="flex items-center justify-center">
                        <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
                        Confirm Order
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- Other Modals (Auth, Account, Address, Bill) - Same as before -->
    <div id="account-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-end md:items-center justify-center p-0 md:p-4" onclick="closeAccountModal(event)">
        <div class="bg-white rounded-t-2xl md:rounded-2xl shadow-2xl w-full max-w-5xl h-[90vh] md:h-[700px] flex flex-col md:flex-row overflow-hidden" onclick="event.stopPropagation()">
            <div class="w-full md:w-1/4 bg-gray-50 border-b md:border-r border-gray-200 flex flex-row md:flex-col overflow-x-auto md:overflow-visible no-scrollbar shrink-0">
                <div class="p-4 md:p-8 border-r md:border-r-0 md:border-b border-gray-200 shrink-0 hidden md:block"><h3 class="text-lg font-bold text-primary">My Account</h3></div>
                <nav class="flex md:flex-col p-2 md:p-4 space-x-2 md:space-x-0 md:space-y-2">
                    <button onclick="switchAccountTab('profile')" id="tab-btn-profile" class="account-tab-btn whitespace-nowrap px-4 py-3 md:rounded-lg text-sm font-medium text-gray-500 hover:text-primary transition flex items-center rounded-full md:rounded-lg bg-white md:bg-transparent border border-gray-200 md:border-transparent shadow-sm md:shadow-none"><i data-lucide="user" class="w-4 h-4 mr-2"></i> Profile</button>
                    <button onclick="switchAccountTab('orders')" id="tab-btn-orders" class="account-tab-btn whitespace-nowrap px-4 py-3 md:rounded-lg text-sm font-medium text-gray-500 hover:text-primary transition flex items-center rounded-full md:rounded-lg bg-white md:bg-transparent border border-gray-200 md:border-transparent shadow-sm md:shadow-none"><i data-lucide="package" class="w-4 h-4 mr-2"></i> Orders</button>
                    <button onclick="switchAccountTab('addresses')" id="tab-btn-addresses" class="account-tab-btn whitespace-nowrap px-4 py-3 md:rounded-lg text-sm font-medium text-gray-500 hover:text-primary transition flex items-center rounded-full md:rounded-lg bg-white md:bg-transparent border border-gray-200 md:border-transparent shadow-sm md:shadow-none"><i data-lucide="map-pin" class="w-4 h-4 mr-2"></i> Address</button>
                    <button onclick="handleLogout()" class="whitespace-nowrap px-4 py-3 md:rounded-lg text-sm font-medium text-red-500 hover:bg-red-50 transition flex items-center md:mt-auto"><i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Logout</button>
                </nav>
            </div>
            <div class="w-full md:w-3/4 p-6 md:p-10 overflow-y-auto bg-white relative flex-grow">
                <button onclick="toggleAccountModal()" class="absolute top-4 right-4 p-2 hover:bg-gray-100 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button>
                <div id="tab-content-profile" class="account-tab-content hidden">
                    <h2 class="text-2xl font-light text-primary mb-8">Profile Details</h2>
                    <div class="space-y-5 max-w-md">
                        <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1 tracking-wider">Full Name</label><input type="text" id="profile-name-input" class="w-full p-3 border border-gray-200 rounded-lg bg-gray-50 font-medium"></div>
                        <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1 tracking-wider">Email Address</label><input type="email" id="profile-email-input" disabled class="w-full p-3 border border-gray-200 rounded-lg bg-gray-100 text-gray-500 font-medium"></div>
                    </div>
                </div>
                <div id="tab-content-orders" class="account-tab-content hidden">
                    <h2 class="text-2xl font-light text-primary mb-8">My Orders</h2>
                    <div id="orders-list-container" class="space-y-4 pb-10"></div>
                </div>
                <div id="tab-content-addresses" class="account-tab-content hidden">
                    <h2 class="text-2xl font-light text-primary mb-8">Address Book</h2>
                    <div id="address-list-container" class="space-y-4"></div>
                    <button onclick="openAddressForm()" class="mt-6 w-full py-3 border-2 border-dashed border-gray-300 rounded-xl hover:border-primary hover:bg-gray-50 transition flex justify-center items-center font-bold text-sm text-primary"><i data-lucide="plus" class="w-4 h-4 mr-2"></i> Add New Address</button>
                </div>
            </div>
        </div>
    </div>

    <div id="address-form-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 animate-scale-in border border-gray-100">
            <h3 class="text-xl font-bold mb-6 text-primary flex items-center" id="address-form-title">
                <i data-lucide="map-pin" class="w-5 h-5 mr-2 text-accent"></i>
                Add Address
            </h3>
            <form id="address-form" onsubmit="handleAddressSubmit(event)">
                <input type="hidden" id="address-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1.5 tracking-wider">Full Name</label>
                        <input type="text" id="addr-name" placeholder="Enter full name" required class="w-full p-3.5 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-accent focus:ring-2 focus:ring-accent/20 outline-none transition-all duration-300">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1.5 tracking-wider">Address Line 1</label>
                        <input type="text" id="addr-street" placeholder="Street address" required class="w-full p-3.5 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-accent focus:ring-2 focus:ring-accent/20 outline-none transition-all duration-300">
                    </div>
                    <div class="flex space-x-4">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1.5 tracking-wider">City</label>
                            <input type="text" id="addr-city" placeholder="City" required class="w-full p-3.5 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-accent focus:ring-2 focus:ring-accent/20 outline-none transition-all duration-300">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1.5 tracking-wider">ZIP Code</label>
                            <input type="text" id="addr-zip" placeholder="ZIP" required class="w-full p-3.5 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-accent focus:ring-2 focus:ring-accent/20 outline-none transition-all duration-300">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1.5 tracking-wider">Phone Number</label>
                        <input type="tel" id="addr-phone" placeholder="Phone number" required class="w-full p-3.5 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-accent focus:ring-2 focus:ring-accent/20 outline-none transition-all duration-300">
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" onclick="closeAddressForm()" class="px-6 py-2.5 text-gray-500 font-medium hover:bg-gray-100 rounded-lg transition-all duration-200 active:scale-95">Cancel</button>
                    <button type="submit" class="px-8 py-2.5 bg-primary text-white font-bold rounded-lg hover:bg-accent transition-all duration-300 shadow-lg active:scale-95">
                        <span class="flex items-center">
                            <i data-lucide="check" class="w-4 h-4 mr-1.5"></i>
                            Save
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contact Us Chat Modal -->
    <div id="contact-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4" onclick="closeContactModal(event)">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col animate-scale-in border border-gray-100" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-primary flex items-center">
                    <i data-lucide="message-circle" class="w-5 h-5 mr-2 text-accent"></i>
                    Contact Us
                </h3>
                <button onclick="closeContactModal()" class="p-2 hover:bg-gray-100 rounded-full transition">
                    <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                </button>
            </div>
            <div id="contact-chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 min-h-[300px] max-h-[400px] custom-scroll">
                <!-- Messages will be loaded here -->
            </div>
            <div class="p-6 border-t border-gray-200">
                <form id="contact-form" onsubmit="sendContactMessage(event)" class="flex space-x-3">
                    <input type="text" id="contact-message-input" placeholder="Type your message..." required class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-accent focus:ring-2 focus:ring-accent/20 outline-none">
                    <button type="submit" class="px-6 py-3 bg-primary text-white rounded-xl hover:bg-accent transition font-medium">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="auth-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4" onclick="closeAuthModal(event)">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm transform transition-all scale-100 border border-gray-100" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-8">
                <h3 id="auth-title" class="text-2xl font-light text-primary flex items-center">
                    <i data-lucide="user" class="w-6 h-6 mr-2 text-accent"></i>
                    Welcome
                </h3>
                <button onclick="toggleAuthModal()" class="p-2 hover:bg-gray-100 rounded-full transition-all duration-200 active:scale-95" aria-label="Close">
                    <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                </button>
            </div>
            <form id="auth-form" onsubmit="handleAuthSubmit(event)">
                <div id="auth-name-container" class="mb-4 hidden">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1.5 tracking-wider">Name</label>
                    <input type="text" id="auth-name" placeholder="Enter your name" class="w-full p-3.5 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-accent focus:ring-2 focus:ring-accent/20 transition-all duration-300 outline-none">
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1.5 tracking-wider">Email</label>
                    <input type="email" id="auth-email" placeholder="Enter your email" required class="w-full p-3.5 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-accent focus:ring-2 focus:ring-accent/20 transition-all duration-300 outline-none">
                </div>
                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1.5 tracking-wider">Password</label>
                    <input type="password" id="auth-password" placeholder="Enter your password" required class="w-full p-3.5 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-accent focus:ring-2 focus:ring-accent/20 transition-all duration-300 outline-none">
                </div>
                <button type="submit" class="w-full luxury-button font-bold py-3.5 rounded-xl mb-4 shadow-lg transition-all duration-300">
                    <span class="flex items-center justify-center">
                        <i data-lucide="arrow-right" class="w-4 h-4 mr-2"></i>
                        CONTINUE
                    </span>
                </button>
                <div class="relative mb-6">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-200"></div>
                    </div>
                    <div class="relative flex justify-center text-xs uppercase text-gray-400 tracking-widest">
                        <span class="px-3 bg-white">Or</span>
                    </div>
                </div>
                <button type="button" onclick="handleGoogleLogin()" class="w-full border-2 border-gray-200 text-gray-600 font-bold py-3.5 rounded-xl hover:bg-gray-50 hover:border-gray-300 flex items-center justify-center transition-all duration-300 active:scale-95">
                    <i data-lucide="chrome" class="w-5 h-5 mr-2"></i>
                    Continue with Google
                </button>
            </form>
            <p class="text-center mt-6 text-sm text-gray-500">
                <span id="auth-switch-text">New here?</span> 
                <a href="#" onclick="switchAuthMode(event)" id="auth-switch-btn" class="text-primary font-bold hover:text-accent hover:underline cursor-pointer transition-colors ml-1">Create Account</a>
            </p>
        </div>
    </div>

    <div id="bill-modal" class="fixed inset-0 bg-black/70 z-[70] hidden flex items-center justify-center p-4" onclick="if(event.target.id === 'bill-modal') document.getElementById('bill-modal').classList.add('hidden')">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col overflow-hidden animate-scale-in">
            <div class="bg-primary p-6 text-white text-center relative shrink-0"><h3 class="font-bold text-xl tracking-[0.2em] mb-1">PRISM HOLD</h3><p class="text-white/70 text-xs uppercase tracking-widest">Official Receipt</p><button onclick="document.getElementById('bill-modal').classList.add('hidden')" class="absolute top-4 right-4 text-white/50 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <div class="p-6 overflow-y-auto custom-scroll flex-grow" id="bill-content"></div>
            <div class="bg-gray-50 p-4 text-center border-t border-gray-100 shrink-0"><button onclick="window.print()" class="text-primary font-bold hover:text-accent flex items-center justify-center w-full py-2"><i data-lucide="printer" class="w-4 h-4 mr-2"></i> Save / Print</button></div>
        </div>
    </div>

    <div id="alert-box" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[80] space-y-2 w-11/12 max-w-sm pointer-events-none"></div>
    
    <!-- Product Added Notification Container -->
    <div id="product-notification-container" class="fixed top-20 right-4 z-[85] space-y-3 w-80 max-w-[calc(100vw-2rem)] pointer-events-none"></div>

    <!-- Product Detail Modal -->
    <div id="product-detail-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[90] hidden flex items-center justify-center p-4" onclick="closeProductDetailModal(event)">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col overflow-hidden animate-scale-in" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-6 border-b border-gray-100 bg-white/98 backdrop-blur-sm shrink-0">
                <h2 class="text-xl font-bold text-primary flex items-center">
                    <i data-lucide="sparkles" class="w-5 h-5 mr-2 text-accent"></i>
                    Product Details
                </h2>
                <button onclick="closeProductDetailModal(event, true)" class="p-2 hover:bg-gray-100 rounded-full transition-all duration-200 active:scale-95" aria-label="Close product details">
                    <i data-lucide="x" class="w-6 h-6 text-gray-500"></i>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll p-6 md:p-8">
                <div class="flex flex-col md:flex-row gap-8 mb-8">
                    <div class="w-full md:w-1/2">
                        <div class="aspect-square bg-gradient-to-br from-gray-100 to-gray-50 rounded-2xl overflow-hidden mb-4 shadow-lg border-2 border-gray-100 relative">
                            <img id="product-detail-image" src="" class="w-full h-full object-cover transition-transform duration-500 hover:scale-105" alt="Product">
                            <div id="product-detail-image-nav" class="absolute inset-0 flex items-center justify-between p-4 opacity-0 hover:opacity-100 transition-opacity">
                                <button id="product-detail-prev" onclick="changeProductImage(-1)" class="bg-white/90 backdrop-blur-sm rounded-full p-2 shadow-lg hover:bg-white transition">
                                    <i data-lucide="chevron-left" class="w-6 h-6 text-gray-700"></i>
                                </button>
                                <button id="product-detail-next" onclick="changeProductImage(1)" class="bg-white/90 backdrop-blur-sm rounded-full p-2 shadow-lg hover:bg-white transition">
                                    <i data-lucide="chevron-right" class="w-6 h-6 text-gray-700"></i>
                                </button>
                            </div>
                        </div>
                        <div id="product-detail-thumbnails" class="flex gap-2 overflow-x-auto pb-2">
                            <!-- Thumbnails will be added here -->
                        </div>
                    </div>
                    <div class="w-full md:w-1/2">
                        <p id="product-detail-category" class="text-xs text-gray-400 uppercase tracking-wider mb-3 font-semibold"></p>
                        <h1 id="product-detail-name" class="text-3xl md:text-4xl font-bold text-primary mb-4 leading-tight"></h1>
                        <p id="product-detail-price" class="text-4xl font-bold text-accent mb-8"></p>
                        
                        <div class="space-y-5 mb-8">
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 flex items-center">
                                    <i data-lucide="package" class="w-3 h-3 mr-1.5 text-accent"></i>
                                    Material
                                </h3>
                                <p id="product-detail-material" class="text-sm text-gray-800 font-medium"></p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 flex items-center">
                                    <i data-lucide="file-text" class="w-3 h-3 mr-1.5 text-accent"></i>
                                    Description
                                </h3>
                                <p id="product-detail-description" class="text-sm text-gray-800 leading-relaxed"></p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 flex items-center">
                                    <i data-lucide="list" class="w-3 h-3 mr-1.5 text-accent"></i>
                                    Details
                                </h3>
                                <ul id="product-detail-details" class="text-sm text-gray-800 space-y-2 list-none"></ul>
                            </div>
                        </div>
                        
                        <button id="product-detail-add-cart" onclick="addToCartFromDetail()" class="w-full accent-button font-bold py-4.5 rounded-xl shadow-lg transform transition-all duration-300 active:scale-95 text-sm tracking-widest uppercase mb-4 hover:shadow-xl">
                            <span class="flex items-center justify-center">
                                <i data-lucide="shopping-cart" class="w-5 h-5 mr-2"></i>
                                Add to Cart
                            </span>
                        </button>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 pt-8">
                    <h3 class="text-xl font-bold text-primary mb-6">You May Also Like</h3>
                    <div id="product-recommendations" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Confirmation Modal -->
    <div id="order-confirmation-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[90] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center animate-scale-in">
            <div id="confirmation-icon" class="mb-6 flex justify-center">
                <div class="w-20 h-20 rounded-full bg-accent/10 flex items-center justify-center">
                    <i data-lucide="loader-2" class="w-10 h-10 text-accent animate-spin"></i>
                </div>
            </div>
            <h3 id="confirmation-title" class="text-2xl font-bold text-primary mb-2">Confirming...</h3>
            <p id="confirmation-message" class="text-gray-600 text-sm mb-6">Please wait while we process your order</p>
            <div id="confirmation-progress" class="w-full bg-gray-200 rounded-full h-1.5 mb-4">
                <div id="confirmation-progress-bar" class="bg-accent h-1.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        let products = [];

        // Mock Data for persistence in demo mode
        const mockDB = { addresses: [], orders: [], carts: {} };
        let cartItems = [];
        let selectedCartItems = new Set(); // Track selected cart item IDs
        let selectedAddressId = null;
        let discountMultiplier = 1; 
        let userAddresses = [];
        let userOrders = [];
        let authMode = 'login';
        let currentCategory = 'all';
        const businessPhone = "917257857609"; 
        const formatCurrency = (amount) => `₹${amount.toLocaleString('en-IN', { maximumFractionDigits: 0, minimumFractionDigits: 0 })}`;

        function alertMessage(message, type = 'info') {
            const box = document.getElementById('alert-box');
            const alertDiv = document.createElement('div');
            let bgColor = type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : 'bg-gray-800');
            alertDiv.className = `${bgColor} text-white px-6 py-3 rounded-full shadow-2xl flex items-center justify-center text-sm font-medium opacity-0 transform -translate-y-2 transition-all duration-300 pointer-events-auto backdrop-blur-md border border-white/10`;
            alertDiv.innerHTML = `<span>${message}</span>`;
            box.appendChild(alertDiv);
            setTimeout(() => { alertDiv.classList.remove('opacity-0', '-translate-y-2'); }, 10);
            setTimeout(() => { alertDiv.classList.add('opacity-0', '-translate-y-2'); setTimeout(() => alertDiv.remove(), 300); }, 3000);
        }

        function setCategory(cat) {
            currentCategory = cat;
            document.querySelectorAll('.category-btn').forEach(btn => {
                if(btn.dataset.cat === cat) {
                    btn.classList.add('active', 'bg-primary', 'text-white', 'border-primary');
                    btn.classList.remove('bg-white', 'text-gray-600', 'border-gray-200');
                } else {
                    btn.classList.remove('active', 'bg-primary', 'text-white', 'border-primary');
                    btn.classList.add('bg-white', 'text-gray-600', 'border-gray-200');
                }
            });
            filterProducts();
        }

        function filterProducts() {
            const q = document.getElementById('product-search').value.toLowerCase();
            const filtered = products.filter(p => (currentCategory === 'all' || p.category === currentCategory) && (p.name.toLowerCase().includes(q)));
            const list = document.getElementById('product-list');
            list.innerHTML = filtered.length ? filtered.map(p => {
                const productImage = (p.images && p.images.length > 0) ? p.images[0] : (p.image || '');
                return `
                <div class="bg-white rounded-2xl overflow-hidden product-card-modern group cursor-pointer" onclick="openProductDetail(${p.id})">
                    <div class="product-image-wrapper aspect-square bg-gray-100 relative">
                        <img src="${productImage}" class="product-image" loading="lazy" alt="${p.name}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 400 400\\'%3E%3Crect fill=\\'%23f3f4f6\\' width=\\'400\\' height=\\'400\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' font-family=\\'sans-serif\\' font-size=\\'18\\' fill=\\'%239ca3af\\'%3EImage%3C/text%3E%3C/svg%3E'">
                        <button onclick="event.stopPropagation(); addToCart(${p.id})" class="absolute bottom-4 right-4 bg-white/95 backdrop-blur-md text-primary w-11 h-11 rounded-full flex items-center justify-center shadow-xl transform translate-y-12 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-400 hover:bg-primary hover:text-white hover:scale-110 active:scale-95 z-10" aria-label="Add to cart">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    </div>
                    <div class="p-5">
                        <p class="text-xs text-gray-400 uppercase tracking-wider mb-2 font-semibold">${p.category}</p>
                        <h3 class="text-sm font-bold text-gray-900 line-clamp-2 mb-2 leading-snug min-h-[2.5rem]">${p.name}</h3>
                        <p class="text-lg font-bold text-accent">${formatCurrency(p.price)}</p>
                    </div>
                </div>`;
            }).join('') : '<div class="col-span-full empty-state"><div class="empty-state-icon"><i data-lucide="search-x" class="w-16 h-16 mx-auto text-gray-300"></i></div><p class="text-gray-400 text-base mb-2 font-medium">No products found</p><p class="text-gray-400 text-sm">Try adjusting your search or filters</p></div>';
            lucide.createIcons();
        }

        function toggleAuthModal(mode) {
            const modal = document.getElementById('auth-modal');
            const title = document.getElementById('auth-title');
            const nameContainer = document.getElementById('auth-name-container');
            const switchText = document.getElementById('auth-switch-text');
            const switchBtn = document.getElementById('auth-switch-btn');
            
            if (mode) {
                authMode = mode;
                title.textContent = authMode === 'login' ? 'Welcome Back' : 'Create Account';
                nameContainer.classList.toggle('hidden', authMode === 'login');
                switchText.textContent = authMode === 'login' ? "New here?" : "Already have an account?";
                switchBtn.textContent = authMode === 'login' ? "Create Account" : "Login";
                if(modal.classList.contains('hidden')) modal.classList.remove('hidden');
            } else {
                modal.classList.toggle('hidden');
            }
        }
        function switchAuthMode(e) {
            e.preventDefault();
            const newMode = authMode === 'login' ? 'signup' : 'login';
            toggleAuthModal(newMode);
        }

        // --- API AUTHENTICATION ---
        window.updateAuthUI = async function(isLoggedIn) {
            const btnContainer = document.getElementById('auth-buttons-desktop');
            const placeholder = document.getElementById('auth-buttons-desktop-placeholder');
            if (isLoggedIn && window.currentUser) {
                if (placeholder) placeholder.classList.add('hidden');
                btnContainer.innerHTML = `<button onclick="openAccountModal('profile')" class="text-primary hover:text-accent transition-colors font-medium text-xs tracking-wider">ACCOUNT</button>`;
                btnContainer.classList.remove('hidden');
                try {
                    const profile = await apiRequest('/profile');
                    const email = profile.email || window.currentUser.email;
                    const name = profile.displayName || window.currentUser.displayName;
                    document.getElementById('profile-email-input').value = email || "";
                    document.getElementById('profile-name-input').value = name || "";
                } catch (error) {
                    console.error('Failed to load profile:', error);
                }
            } else {
                if (placeholder) placeholder.classList.remove('hidden');
                btnContainer.innerHTML = `<button onclick="toggleAuthModal('login')" class="text-primary hover:text-accent transition-colors font-medium text-xs tracking-wider">LOGIN</button>`;
                btnContainer.classList.remove('hidden');
            }
            lucide.createIcons();
        };

        window.initUserDataListeners = async function(uid) {
            if (mockDB.carts[uid]) { 
                cartItems = mockDB.carts[uid]; 
            } else {
                try {
                    const cartData = await apiRequest('/cart');
                    cartItems = cartData.items || [];
                        renderCart();
                        if (!document.getElementById('checkout-modal').classList.contains('hidden')) renderCheckoutSummary();
                } catch (error) {
                    console.error('Failed to load cart:', error);
                    }
            }
            renderCart();

            // Load addresses
            try {
                const addresses = await apiRequest('/addresses');
                userAddresses = addresses;
                renderAddressList(); 
                renderCheckoutAddresses();
            } catch (error) {
                console.error('Failed to load addresses:', error);
            }
            
            // Load orders
            try {
                const orders = await apiRequest('/orders');
                userOrders = orders;
                renderOrdersList();
            } catch (error) {
                console.error('Failed to load orders:', error);
            }
            
            // Set up polling for real-time updates (simulating onSnapshot)
            window.userDataPollInterval = setInterval(async () => {
                if (window.currentUser) {
                    try {
                        const cartData = await apiRequest('/cart');
                        const newItems = cartData.items || [];
                        if (JSON.stringify(newItems) !== JSON.stringify(cartItems)) {
                            cartItems = newItems;
                            renderCart();
                            if (!document.getElementById('checkout-modal').classList.contains('hidden')) renderCheckoutSummary();
                        }
                        
                        const addresses = await apiRequest('/addresses');
                        if (JSON.stringify(addresses) !== JSON.stringify(userAddresses)) {
                            userAddresses = addresses;
                            renderAddressList();
                            renderCheckoutAddresses();
                        }
                        
                        const orders = await apiRequest('/orders');
                        if (JSON.stringify(orders) !== JSON.stringify(userOrders)) {
                            userOrders = orders;
                            renderOrdersList();
                        }
                    } catch (error) {
                        console.error('Polling error:', error);
                    }
                }
            }, 2000); // Poll every 2 seconds
        };

        async function handleAuthSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            try {
                if (authMode === 'login') {
                    const response = await apiRequest('/auth/login', {
                        method: 'POST',
                        body: JSON.stringify({ email, password })
                    });
                    setAuthToken(response.token);
                    setCurrentUser(response.user);
                    window.currentUser = response.user;
                    window.updateAuthUI(true);
                    window.initUserDataListeners(response.user.uid);
                    alertMessage("Welcome back!", "success");
                } else {
                    const name = document.getElementById('auth-name').value;
                    const response = await apiRequest('/auth/signup', {
                        method: 'POST',
                        body: JSON.stringify({ email, password, displayName: name })
                    });
                    setAuthToken(response.token);
                    setCurrentUser(response.user);
                    window.currentUser = response.user;
                    window.updateAuthUI(true);
                    window.initUserDataListeners(response.user.uid);
                    alertMessage("Account created!", "success");
                }
                toggleAuthModal();
            } catch (error) { 
                alertMessage(error.message || "Authentication failed", "error"); 
            }
        }

        async function handleGoogleLogin() {
            try {
                alertMessage("Google login is being set up. Please use email/password for now.", "info");
                // TODO: Implement Google OAuth with proper client ID
                // For now, users can use email/password authentication
                // To enable Google login, you need to:
                // 1. Set up Google OAuth credentials
                // 2. Add GOOGLE_CLIENT_ID to your server environment
                // 3. Implement Google Sign-In button in the UI
            } catch (error) { 
                console.error('Google login error:', error);
                alertMessage("Google Login Failed. Please use email/password.", "error"); 
            }
        }

        async function handleLogout() {
            try {
                if (window.currentUser) mockDB.carts[window.currentUser.uid] = [...cartItems];
                setAuthToken(null);
                setCurrentUser(null);
                window.currentUser = null;
                if (window.userDataPollInterval) {
                    clearInterval(window.userDataPollInterval);
                    window.userDataPollInterval = null;
                }
                cartItems = []; userAddresses = []; userOrders = []; selectedAddressId = null;
                renderCart(); toggleCart(false);
                document.getElementById('account-modal').classList.add('hidden');
                window.updateAuthUI(false);
                alertMessage("See you soon!", "success");
            } catch(e) { console.error(e); }
        }

        // --- APP LOGIC ---
        async function saveCart() { 
            if(window.currentUser) {
                mockDB.carts[window.currentUser.uid] = [...cartItems];
                try {
                    await apiRequest('/cart', {
                        method: 'PUT',
                        body: JSON.stringify({ items: cartItems })
                    });
                } catch (error) {
                    console.error('Failed to save cart:', error);
                }
            }
        }
        
        function toggleCartItemSelection(id) {
            if(selectedCartItems.has(id)) {
                selectedCartItems.delete(id);
            } else {
                selectedCartItems.add(id);
            }
            renderCart();
        }
        
        function toggleSelectAllCartItems() {
            const allSelected = cartItems.length > 0 && cartItems.every(item => selectedCartItems.has(item.id));
            if(allSelected) {
                selectedCartItems.clear();
            } else {
                cartItems.forEach(item => selectedCartItems.add(item.id));
            }
            renderCart();
        }
        
        function deleteSelectedCartItems() {
            const selectedItems = cartItems.filter(i => selectedCartItems.has(i.id));
            if(selectedItems.length === 0) {
                alertMessage("No items selected", "info");
                return;
            }
            if(confirm(`Delete ${selectedItems.length} selected item(s) from cart?`)) {
                selectedItems.forEach(item => {
                    const index = cartItems.findIndex(i => i.id === item.id);
                    if(index !== -1) cartItems.splice(index, 1);
                    selectedCartItems.delete(item.id);
                });
                renderCart();
                saveCart();
                alertMessage(`${selectedItems.length} item(s) removed from cart`, "success");
            }
        }
        
        function showProductAddedNotification(product) {
            const container = document.getElementById('product-notification-container');
            const notification = document.createElement('div');
            const isNewItem = !cartItems.find(x => x.id === product.id);
            const item = cartItems.find(x => x.id === product.id);
            const quantity = item ? item.quantity : 1;
            const productImage = (product.images && product.images.length > 0) ? product.images[0] : (product.image || '');
            
            notification.className = 'product-added-notification bg-white rounded-xl shadow-2xl p-4 border border-gray-100 flex items-center space-x-4 pointer-events-auto';
            notification.innerHTML = `
                <div class="flex-shrink-0">
                    <div class="w-16 h-16 rounded-lg overflow-hidden border-2 border-accent product-added-icon">
                        <img src="${productImage}" class="w-full h-full object-cover" alt="${product.name}">
                    </div>
                </div>
                <div class="flex-grow min-w-0">
                    <div class="flex items-center space-x-2 mb-1">
                        <i data-lucide="check-circle" class="w-5 h-5 text-green-600 flex-shrink-0 product-added-icon"></i>
                        <p class="text-sm font-bold text-primary line-clamp-1">${isNewItem ? 'Added to Cart' : 'Quantity Updated'}</p>
                    </div>
                    <p class="text-xs text-gray-600 line-clamp-1 mb-1">${product.name}</p>
                    <p class="text-xs font-bold text-accent">${formatCurrency(product.price)} ${quantity > 1 ? `× ${quantity}` : ''}</p>
                </div>
            `;
            
            container.appendChild(notification);
            lucide.createIcons();
            
            // Remove notification after animation
            setTimeout(() => {
                notification.remove();
            }, 2500);
        }
        
        function addToCart(id) { 
            const p = products.find(x => x.id === id); 
            if (!p) return;
            // Calculate final price with discount
            const finalPrice = p.discount ? p.price * (1 - p.discount / 100) : p.price;
            const productWithPrice = { ...p, price: finalPrice, originalPrice: p.price };
            const item = cartItems.find(x => x.id === id);
            if(item) {
                item.quantity++; 
            } else {
                cartItems.push({...productWithPrice, quantity: 1});
            }
            selectedCartItems.add(id); // Auto-select new items
            renderCart(); saveCart();
            showProductAddedNotification(p);
            if(!document.getElementById('checkout-modal').classList.contains('hidden')) renderCheckoutSummary();
            else {
                const btn = document.querySelector(`button[onclick="toggleCart()"]`);
                btn.classList.add('scale-110'); setTimeout(() => btn.classList.remove('scale-110'), 200);
            }
        }
        
        function updateQuantity(id, d) { 
            const item = cartItems.find(x => x.id === id); 
            if(item) { 
                item.quantity+=d; 
                if(item.quantity<=0) {
                    cartItems = cartItems.filter(x=>x.id!==id);
                    selectedCartItems.delete(id);
                }
            } 
            renderCart(); saveCart(); 
            if(!document.getElementById('checkout-modal').classList.contains('hidden')) renderCheckoutSummary();
        }
        
        function renderCart() {
            const list = document.getElementById('cart-items-list');
            let total = 0, count = 0;
            const selectedItems = cartItems.filter(i => selectedCartItems.has(i.id));
            selectedItems.forEach(i => { total += i.price * i.quantity; count += i.quantity; });
            
            const allSelected = cartItems.length > 0 && cartItems.every(item => selectedCartItems.has(item.id));
            
            list.innerHTML = cartItems.length ? `
                <div class="mb-5 pb-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <label class="flex items-center cursor-pointer group">
                            <input type="checkbox" ${allSelected ? 'checked' : ''} onchange="toggleSelectAllCartItems()" class="w-5 h-5 accent-accent rounded border-gray-300 cursor-pointer transition-all">
                            <span class="ml-3 text-sm font-bold text-primary group-hover:text-accent transition-colors">Select All (${selectedItems.length}/${cartItems.length})</span>
                        </label>
                        ${selectedItems.length > 0 ? `
                            <button onclick="deleteSelectedCartItems()" class="flex items-center space-x-2 px-4 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg transition-all duration-200 text-xs font-bold active:scale-95">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                <span>Delete</span>
                            </button>
                        ` : ''}
                    </div>
                </div>
                ${cartItems.map(i => {
                    const isSelected = selectedCartItems.has(i.id);
                    const itemImage = (i.images && i.images.length > 0) ? i.images[0] : (i.image || '');
                    return `<div class="flex items-start p-4 bg-white rounded-2xl mb-4 border-2 ${isSelected ? 'border-accent shadow-lg bg-accent/5' : 'border-gray-100'} shadow-sm transition-all duration-300 hover:shadow-md">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleCartItemSelection(${i.id})" class="mt-1 w-5 h-5 accent-accent rounded border-gray-300 cursor-pointer mr-4 flex-shrink-0 transition-all">
                        <img src="${itemImage}" class="w-20 h-20 object-cover rounded-xl mr-4 flex-shrink-0 shadow-sm border border-gray-100" alt="${i.name}">
                        <div class="flex-grow min-w-0">
                            <p class="font-bold text-sm text-primary line-clamp-2 mb-1 leading-snug">${i.name}</p>
                            <div class="text-xs text-gray-500 mb-3 font-medium">
                                ${i.originalPrice && i.originalPrice > i.price ? `
                                    <span class="line-through text-gray-400">${formatCurrency(i.originalPrice)}</span>
                                    <span class="text-accent font-bold ml-1">${formatCurrency(i.price)}</span>
                                ` : formatCurrency(i.price)} each
                            </div>
                            <div class="flex items-center space-x-3">
                                <button onclick="updateQuantity(${i.id}, -1)" class="w-7 h-7 flex items-center justify-center bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700 font-bold transition-all duration-200 active:scale-90">−</button>
                                <span class="text-sm font-bold text-primary min-w-[24px] text-center">${i.quantity}</span>
                                <button onclick="updateQuantity(${i.id}, 1)" class="w-7 h-7 flex items-center justify-center bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700 font-bold transition-all duration-200 active:scale-90">+</button>
                            </div>
                        </div>
                        <button onclick="updateQuantity(${i.id}, -${i.quantity})" class="text-gray-300 hover:text-red-500 self-start ml-2 flex-shrink-0 p-2 rounded-lg hover:bg-red-50 transition-all duration-200 active:scale-90" aria-label="Remove item">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>`;
                }).join('')}
            ` : '<div class="flex flex-col items-center justify-center h-64 text-gray-300"><div class="empty-state-icon mb-4"><i data-lucide="shopping-bag" class="w-16 h-16 mx-auto text-gray-300"></i></div><p class="text-base mb-2 font-medium text-gray-400">Your cart is empty</p><p class="text-sm text-gray-400 mb-6">Start adding items to your cart</p><button onclick="document.getElementById(\'cart-modal\').classList.remove(\'open\'); document.getElementById(\'shop\').scrollIntoView({ behavior: \'smooth\' });" class="px-8 py-3.5 bg-primary text-white rounded-full text-sm font-bold tracking-widest uppercase hover:bg-accent transition-all duration-300 shadow-lg hover:shadow-xl hover:-translate-y-0.5">Shop Now</button></div>';
            document.getElementById('cart-count-desktop').textContent = count; document.getElementById('cart-count-mobile').textContent = count; document.getElementById('cart-subtotal').textContent = formatCurrency(total);
            const badge = document.getElementById('cart-count-bottom'); if(count > 0) { badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
            lucide.createIcons();
        }
        
        function renderCheckoutSummary() {
            const list = document.getElementById('checkout-product-list');
            if (!list) return;

            const selectedItems = cartItems.filter(i => selectedCartItems.has(i.id));
            let subtotal = 0;
            if (selectedItems && selectedItems.length > 0) {
                subtotal = selectedItems.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            }
            const total = subtotal - discountAmount;

            if (selectedItems.length === 0) {
                list.innerHTML = '<div class="text-center py-8 text-gray-400"><i data-lucide="shopping-bag" class="w-12 h-12 mx-auto mb-3 opacity-30"></i><p class="text-sm">No items selected</p></div>';
                lucide.createIcons();
                return;
            }
            
            list.innerHTML = selectedItems.map(i => {
                const t = i.price * i.quantity;
                const itemImage = (i.images && i.images.length > 0) ? i.images[0] : (i.image || '');
                return `<div class="flex justify-between items-center py-4 border-b border-dashed border-gray-200 last:border-0 hover:bg-gray-50/50 rounded-lg px-2 -mx-2 transition-colors">
                            <div class="flex items-center flex-1 min-w-0">
                                <img src="${itemImage}" class="w-16 h-16 rounded-xl object-cover mr-4 border-2 border-gray-100 shadow-sm flex-shrink-0" alt="${i.name}">
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-bold text-gray-800 line-clamp-2 mb-2">${i.name}</p>
                                    <div class="flex items-center flex-wrap gap-2 text-xs">
                                        <span class="text-gray-500 font-medium">${formatCurrency(i.price)} each</span>
                                        <div class="flex items-center space-x-2 bg-white rounded-lg p-1 border-2 border-gray-200 shadow-sm">
                                            <button onclick="updateQuantity(${i.id}, -1)" class="w-7 h-7 flex items-center justify-center bg-gray-50 rounded-md text-base font-bold text-gray-700 hover:bg-gray-100 transition-all duration-200 active:scale-90">−</button>
                                            <span class="text-sm font-bold text-primary w-6 text-center">${i.quantity}</span>
                                            <button onclick="updateQuantity(${i.id}, 1)" class="w-7 h-7 flex items-center justify-center bg-gray-50 rounded-md text-base font-bold text-gray-700 hover:bg-gray-100 transition-all duration-200 active:scale-90">+</button>
                                        </div>
                                        <button onclick="updateQuantity(${i.id}, -${i.quantity})" class="text-red-400 hover:text-red-600 p-1.5 rounded-lg hover:bg-red-50 transition-all duration-200 active:scale-90" aria-label="Remove">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right ml-4 flex-shrink-0">
                                <span class="text-base font-bold text-gray-900">${formatCurrency(t)}</span>
                            </div>
                        </div>`;
            }).join('');
            
            // Safely update elements
            const subtotalEl = document.getElementById('checkout-subtotal');
            if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal);

            const totalEl = document.getElementById('checkout-total');
            if (totalEl) totalEl.textContent = formatCurrency(total);

            const footerTotalEl = document.getElementById('checkout-total-footer');
            if (footerTotalEl) footerTotalEl.textContent = formatCurrency(total);

            const discountEl = document.getElementById('checkout-discount');
            if (discountEl) discountEl.textContent = discountAmount > 0 ? `-${formatCurrency(discountAmount)}` : formatCurrency(0);
            
            lucide.createIcons();
        }

        function handleMobileProfileClick() { if(window.currentUser) openAccountModal('profile'); else toggleAuthModal('login'); }
        function toggleMobileMenu() { document.getElementById('mobile-menu').classList.toggle('-translate-x-full'); }
        function toggleCart() { document.getElementById('cart-modal').classList.toggle('open'); }
        
        let currentProductDetailId = null;
        let currentProductImages = [];
        let currentImageIndex = 0;
        
        function changeProductImage(direction) {
            if (currentProductImages.length <= 1) return;
            currentImageIndex += direction;
            if (currentImageIndex < 0) currentImageIndex = currentProductImages.length - 1;
            if (currentImageIndex >= currentProductImages.length) currentImageIndex = 0;
            
            const img = document.getElementById('product-detail-image');
            img.src = currentProductImages[currentImageIndex];
            updateThumbnailSelection();
            lucide.createIcons();
        }
        
        function updateThumbnailSelection() {
            const thumbnails = document.querySelectorAll('.product-thumbnail');
            thumbnails.forEach((thumb, index) => {
                if (index === currentImageIndex) {
                    thumb.classList.add('ring-2', 'ring-primary', 'ring-offset-2');
                } else {
                    thumb.classList.remove('ring-2', 'ring-primary', 'ring-offset-2');
                }
            });
        }
        
        function openProductDetail(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            
            // Track product view
            fetch(`${API_BASE_URL}/products/${id}/view`, { method: 'POST' }).catch(err => console.error('View tracking error:', err));
            
            currentProductDetailId = id;
            const modal = document.getElementById('product-detail-modal');
            
            // Get product images
            currentProductImages = (product.images && product.images.length > 0) ? product.images : (product.image ? [product.image] : []);
            currentImageIndex = 0;
            
            // Set product details
            document.getElementById('product-detail-image').src = currentProductImages[0] || '';
            document.getElementById('product-detail-image').alt = product.name;
            
            // Show/hide navigation buttons
            const navDiv = document.getElementById('product-detail-image-nav');
            if (currentProductImages.length > 1) {
                navDiv.classList.remove('opacity-0');
            } else {
                navDiv.classList.add('opacity-0');
            }
            
            // Render thumbnails
            const thumbnailsContainer = document.getElementById('product-detail-thumbnails');
            if (currentProductImages.length > 1) {
                thumbnailsContainer.innerHTML = currentProductImages.map((img, index) => `
                    <img src="${img}" alt="Thumbnail ${index + 1}" 
                         class="product-thumbnail w-20 h-20 object-cover rounded-lg cursor-pointer border-2 transition-all ${index === 0 ? 'ring-2 ring-primary ring-offset-2' : 'border-gray-200'}" 
                         onclick="currentImageIndex = ${index}; document.getElementById('product-detail-image').src = '${img}'; updateThumbnailSelection();">
                `).join('');
            } else {
                thumbnailsContainer.innerHTML = '';
            }
            document.getElementById('product-detail-category').textContent = product.category;
            document.getElementById('product-detail-name').textContent = product.name;
            const priceEl = document.getElementById('product-detail-price');
            if (product.discount) {
                const discountedPrice = product.price * (1 - product.discount / 100);
                priceEl.innerHTML = `
                    <span class="text-2xl font-bold text-accent">${formatCurrency(discountedPrice)}</span>
                    <span class="text-lg text-gray-400 line-through ml-2">${formatCurrency(product.price)}</span>
                    <span class="ml-2 text-sm bg-red-100 text-red-600 px-2 py-1 rounded">-${product.discount}%</span>
                `;
            } else {
                priceEl.textContent = formatCurrency(product.price);
            }
            document.getElementById('product-detail-material').textContent = product.material || 'Premium Quality';
            document.getElementById('product-detail-description').textContent = product.description || 'Luxury product with exceptional quality and design.';
            
            // Set details list
            const detailsList = document.getElementById('product-detail-details');
            if (product.details && product.details.length > 0) {
                detailsList.innerHTML = product.details.map(detail => `
                    <li class="flex items-start">
                        <i data-lucide="check" class="w-4 h-4 mr-2 text-accent flex-shrink-0 mt-0.5"></i>
                        <span>${detail}</span>
                    </li>
                `).join('');
            } else {
                detailsList.innerHTML = `
                    <li class="flex items-start">
                        <i data-lucide="check" class="w-4 h-4 mr-2 text-accent flex-shrink-0 mt-0.5"></i>
                        <span>Premium quality materials</span>
                    </li>
                    <li class="flex items-start">
                        <i data-lucide="check" class="w-4 h-4 mr-2 text-accent flex-shrink-0 mt-0.5"></i>
                        <span>Handcrafted design</span>
                    </li>
                    <li class="flex items-start">
                        <i data-lucide="check" class="w-4 h-4 mr-2 text-accent flex-shrink-0 mt-0.5"></i>
                        <span>Durable construction</span>
                    </li>
                `;
            }
            
            // Show recommendations
            showProductRecommendations(id);
            
            modal.classList.remove('hidden');
            lucide.createIcons();
        }
        
        function closeProductDetailModal(e, force) {
            if (force || (e && e.target.id === 'product-detail-modal')) {
                document.getElementById('product-detail-modal').classList.add('hidden');
                currentProductDetailId = null;
            }
        }
        
        function addToCartFromDetail() {
            if (currentProductDetailId) {
                addToCart(currentProductDetailId);
                closeProductDetailModal(null, true);
            }
        }
        
        function showProductRecommendations(currentProductId) {
            const currentProduct = products.find(p => p.id === currentProductId);
            if (!currentProduct) return;
            
            // Get recommendations: same category, excluding current product, limit to 4
            const recommendations = products
                .filter(p => p.id !== currentProductId && p.category.toLowerCase() === currentProduct.category.toLowerCase())
                .slice(0, 4);
            
            // If not enough in same category, add others
            if (recommendations.length < 4) {
                const others = products
                    .filter(p => p.id !== currentProductId && !recommendations.find(r => r.id === p.id))
                    .slice(0, 4 - recommendations.length);
                recommendations.push(...others);
            }
            
            const container = document.getElementById('product-recommendations');
            if (recommendations.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-gray-400">No recommendations available</p>';
                return;
            }
            
            container.innerHTML = recommendations.map(p => {
                const productImage = (p.images && p.images.length > 0) ? p.images[0] : (p.image || '');
                return `
                <div class="bg-white rounded-xl overflow-hidden product-card-modern group cursor-pointer" onclick="openProductDetail(${p.id})">
                    <div class="product-image-wrapper aspect-square bg-gray-100 relative">
                        <img src="${productImage}" class="product-image" loading="lazy" alt="${p.name}">
                        <button onclick="event.stopPropagation(); addToCart(${p.id})" class="absolute bottom-3 right-3 bg-white/90 backdrop-blur text-primary w-10 h-10 rounded-full flex items-center justify-center shadow-lg transform translate-y-10 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300 hover:bg-primary hover:text-white"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div class="p-4">
                        <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">${p.category}</p>
                        <h3 class="text-sm font-bold text-gray-900 line-clamp-1 mb-1">${p.name}</h3>
                        <div class="flex items-center space-x-2">
                            ${p.discount ? `
                                <span class="text-base font-bold text-accent">${formatCurrency(p.price * (1 - p.discount / 100))}</span>
                                <span class="text-xs text-gray-400 line-through">${formatCurrency(p.price)}</span>
                                <span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded">-${p.discount}%</span>
                            ` : `<p class="text-base font-bold text-accent">${formatCurrency(p.price)}</p>`}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            lucide.createIcons();
        }
        
        function closeAuthModal(e) { if (e.target.id === 'auth-modal') toggleAuthModal(); }
        function closeCheckoutModal(e, force) { if (force || e.target.id === 'checkout-modal') document.getElementById('checkout-modal').classList.add('hidden'); }
        function toggleAccountModal() { document.getElementById('account-modal').classList.toggle('hidden'); }
        function closeAccountModal(e) { if (e.target.id === 'account-modal') toggleAccountModal(); }
        function openAccountModal(tab) { document.getElementById('account-modal').classList.remove('hidden'); switchAccountTab(tab); }
        function switchAccountTab(tab) {
            document.querySelectorAll('.account-tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.account-tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-content-${tab}`).classList.remove('hidden');
            const btn = document.getElementById(`tab-btn-${tab}`); if(btn) { btn.classList.add('active'); btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); }
        }
        function openAddressForm(editId=null) { document.getElementById('address-form-modal').classList.remove('hidden'); document.getElementById('address-form').reset(); document.getElementById('address-id').value=''; if(editId){ const a = userAddresses.find(x=>x.id===editId); if(a){ document.getElementById('address-id').value=a.id; document.getElementById('addr-name').value=a.name; document.getElementById('addr-street').value=a.street; document.getElementById('addr-city').value=a.city; document.getElementById('addr-zip').value=a.zip; document.getElementById('addr-phone').value=a.phone; document.getElementById('address-form-title').textContent="Edit Address"; } } else document.getElementById('address-form-title').textContent="Add Address"; }
        function closeAddressForm() { document.getElementById('address-form-modal').classList.add('hidden'); }
        
        // Contact Us Chat
        let currentHelpRequestId = null;
        
        function openContactModal(subject = 'General Inquiry') {
            const modal = document.getElementById('contact-modal');
            modal.classList.remove('hidden');
            currentHelpRequestId = null;
            
            // Load existing help requests or create new
            loadContactMessages(subject);
            lucide.createIcons();
        }
        
        function closeContactModal(e) {
            if (e && e.target.id !== 'contact-modal') return;
            document.getElementById('contact-modal').classList.add('hidden');
        }
        
        async function loadContactMessages(subject = 'General Inquiry') {
            const container = document.getElementById('contact-chat-messages');
            if (!window.currentUser) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8"><p class="mb-4">Please login to contact us</p><button onclick="closeContactModal(); toggleAuthModal(\'login\');" class="px-6 py-2 bg-primary text-white rounded-lg">Login</button></div>';
                return;
            }
            
            try {
                // Try to get existing help request
                const response = await apiRequest('/help-requests');
                const requests = response.filter(r => r.subject === subject || !subject);
                
                if (requests.length > 0) {
                    // Load existing conversation
                    const request = requests[0];
                    currentHelpRequestId = request.id;
                    renderContactMessages(request);
                } else {
                    // New conversation
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            <p>Start a conversation with our support team</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                container.innerHTML = '<div class="text-center text-gray-500 py-4">Start a conversation</div>';
            }
        }
        
        function renderContactMessages(request) {
            const container = document.getElementById('contact-chat-messages');
            const messages = [
                { message: request.message, fromAdmin: false, createdAt: request.createdAt }
            ];
            
            if (request.replies && request.replies.length > 0) {
                messages.push(...request.replies);
            }
            
            messages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            
            container.innerHTML = messages.map(msg => {
                const isAdmin = msg.fromAdmin;
                const date = new Date(msg.createdAt).toLocaleString();
                return `
                    <div class="flex ${isAdmin ? 'justify-start' : 'justify-end'}">
                        <div class="max-w-[70%] ${isAdmin ? 'bg-gray-100' : 'bg-primary text-white'} rounded-2xl px-4 py-3">
                            <p class="text-sm">${msg.message}</p>
                            <p class="text-xs mt-1 ${isAdmin ? 'text-gray-500' : 'text-white/70'}">${date}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }
        
        async function sendContactMessage(e) {
            e.preventDefault();
            if (!window.currentUser) {
                alertMessage('Please login to send messages', 'info');
                closeContactModal();
                toggleAuthModal('login');
                return;
            }
            
            const input = document.getElementById('contact-message-input');
            const message = input.value.trim();
            if (!message) return;
            
            try {
                if (currentHelpRequestId) {
                    // Reply to existing request
                    await apiRequest(`/help-requests/${currentHelpRequestId}/reply`, {
                        method: 'POST',
                        body: JSON.stringify({ message })
                    });
                } else {
                    // Create new help request
                    const request = await apiRequest('/help-requests', {
                        method: 'POST',
                        body: JSON.stringify({
                            subject: 'General Inquiry',
                            message
                        })
                    });
                    currentHelpRequestId = request.id;
                }
                
                input.value = '';
                await loadContactMessages();
                lucide.createIcons();
            } catch (error) {
                console.error('Error sending message:', error);
                alertMessage('Failed to send message', 'error');
            }
        }
        
        let appliedPromoCode = null;
        let discountAmount = 0;
        
        async function applyCoupon() {
            const code = document.getElementById('coupon-code').value.toUpperCase();
            const messageEl = document.getElementById('coupon-message');
            
            if (!code) {
                messageEl.textContent = "Please enter a promo code";
                messageEl.className = "text-xs mt-1 h-4 pl-1 text-red-500";
                return;
            }
            
            const selectedItems = cartItems.filter(i => selectedCartItems.has(i.id));
            const subtotal = selectedItems.reduce((s, i) => s + (i.price * i.quantity), 0);
            
            try {
                const response = await fetch(`${API_BASE_URL}/promo-code/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, items: selectedItems, subtotal })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Invalid promo code');
                }
                
                const data = await response.json();
                appliedPromoCode = code;
                discountAmount = data.discount;
                discountMultiplier = 1 - (discountAmount / subtotal);
                
                messageEl.textContent = `Discount of ${formatCurrency(discountAmount)} applied!`;
                messageEl.className = "text-xs mt-1 h-4 pl-1 text-green-600";
                renderCheckoutSummary();
            } catch (error) {
                appliedPromoCode = null;
                discountAmount = 0;
                discountMultiplier = 1;
                messageEl.textContent = error.message || "Invalid promo code";
                messageEl.className = "text-xs mt-1 h-4 pl-1 text-red-500";
                renderCheckoutSummary();
            }
        }
        function initiateCheckout() { 
            if(!window.currentUser) { alertMessage("Please Login", "info"); toggleAuthModal('login'); return; } 
            const selectedItems = cartItems.filter(i => selectedCartItems.has(i.id));
            if(!selectedItems.length) return alertMessage("Please select items to checkout", "error"); 
            document.getElementById('cart-modal').classList.remove('open'); 
            document.getElementById('checkout-modal').classList.remove('hidden'); 
            renderCheckoutAddresses(); 
            renderCheckoutSummary(); 
        }
        
        function showOrderConfirmation() {
            const modal = document.getElementById('order-confirmation-modal');
            const icon = document.getElementById('confirmation-icon');
            const title = document.getElementById('confirmation-title');
            const message = document.getElementById('confirmation-message');
            const progressBar = document.getElementById('confirmation-progress-bar');
            
            // Reset to initial state
            modal.classList.remove('hidden');
            icon.innerHTML = '<div class="w-20 h-20 rounded-full bg-accent/10 flex items-center justify-center"><i data-lucide="loader-2" class="w-10 h-10 text-accent animate-spin"></i></div>';
            title.textContent = 'Confirming...';
            message.textContent = 'Please wait while we process your order';
            progressBar.style.width = '0%';
            lucide.createIcons();
            
            // Animate progress bar
            setTimeout(() => { progressBar.style.width = '50%'; }, 100);
            setTimeout(() => { progressBar.style.width = '100%'; }, 1500);
            
            // Change to confirmed state after 2 seconds
            setTimeout(() => {
                icon.innerHTML = '<div class="w-20 h-20 rounded-full bg-green-100 flex items-center justify-center animate-checkmark"><i data-lucide="check-circle" class="w-10 h-10 text-green-600"></i></div>';
                title.textContent = 'Order Confirmed!';
                message.textContent = 'Your order has been placed successfully!';
                lucide.createIcons();
            }, 2000);
            
            // Close modal and redirect after 3 seconds
            setTimeout(() => {
                modal.classList.add('hidden');
                window.location.href = '/#shop';
            }, 3000);
        }
        
        async function placeOrder() {
            if(!selectedAddressId) return alertMessage("Select Address", "error");
            const selectedItems = cartItems.filter(i => selectedCartItems.has(i.id));
            if(!selectedItems.length) return alertMessage("Please select items to checkout", "error");
            
            const pay = document.querySelector('input[name="payment_method"]:checked').value;
            const sub = selectedItems.reduce((s,i)=>s+(i.price*i.quantity),0); 
            const tot = sub - discountAmount;
            const addr = userAddresses.find(a=>a.id===selectedAddressId);
            const order = { items: selectedItems, subtotal: sub, total: tot, discount: discountAmount, payment: pay, address: addr, status: 'Pending', date: new Date().toLocaleString(), promoCode: appliedPromoCode };
            
            try {
                // Create order first
                const orderResponse = await apiRequest('/orders', {
                    method: 'POST',
                    body: JSON.stringify(order)
                });
                
                // Create Razorpay order
                const razorpayResponse = await apiRequest('/payments/razorpay/create-order', {
                    method: 'POST',
                    body: JSON.stringify({
                        orderId: orderResponse.id,
                        amount: tot
                    })
                });
                
                if (razorpayResponse.success && razorpayResponse.orderId) {
                    // Razorpay options
                    const options = {
                        key: razorpayResponse.keyId,
                        amount: razorpayResponse.amount,
                        currency: razorpayResponse.currency,
                        name: 'Prism Hold',
                        description: `Order #${orderResponse.id.slice(0, 8).toUpperCase()}`,
                        order_id: razorpayResponse.orderId,
                        handler: async function(response) {
                            // Payment successful, verify on server
                            try {
                                await apiRequest('/payments/razorpay/verify', {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        orderId: orderResponse.id,
                                        razorpayOrderId: response.razorpay_order_id,
                                        razorpayPaymentId: response.razorpay_payment_id,
                                        razorpaySignature: response.razorpay_signature
                                    })
                                });
                                
                                // Remove selected items from cart
                                selectedItems.forEach(item => {
                                    const index = cartItems.findIndex(i => i.id === item.id);
                                    if(index !== -1) cartItems.splice(index, 1);
                                    selectedCartItems.delete(item.id);
                                });
                                
                                renderCart(); saveCart();
                                
                                // Reset promo code
                                appliedPromoCode = null;
                                discountAmount = 0;
                                discountMultiplier = 1;
                                document.getElementById('coupon-code').value = '';
                                document.getElementById('coupon-message').textContent = '';
                                
                                // Close checkout modal
                                document.getElementById('checkout-modal').classList.add('hidden');
                                
                                // Show success message
                                showOrderConfirmation();
                            } catch (error) {
                                console.error('Payment verification error:', error);
                                alertMessage('Payment verification failed. Please contact support.', 'error');
                            }
                        },
                        prefill: {
                            name: addr.name || window.currentUser?.displayName || '',
                            email: window.currentUser?.email || '',
                            contact: addr.phone || ''
                        },
                        theme: {
                            color: '#c5a065'
                        },
                        modal: {
                            ondismiss: function() {
                                alertMessage('Payment cancelled', 'info');
                            }
                        }
                    };
                    
                    // Open Razorpay checkout
                    const razorpayCheckout = new Razorpay(options);
                    razorpayCheckout.open();
                    
                    razorpayCheckout.on('payment.failed', function(response) {
                        console.error('Payment failed:', response.error);
                        alertMessage('Payment failed: ' + (response.error.description || 'Unknown error'), 'error');
                    });
                } else {
                    throw new Error('Failed to create payment order');
                }
            } catch(e) { 
                console.error(e); 
                alertMessage("Failed to process payment: " + (e.message || "Unknown error"), "error"); 
            }
        }
        
        async function handleAddressSubmit(e) { 
            e.preventDefault(); 
            if(!window.currentUser) return; 
            const id = document.getElementById('address-id').value; 
            const d = {
                name: document.getElementById('addr-name').value, 
                street: document.getElementById('addr-street').value, 
                city: document.getElementById('addr-city').value, 
                zip: document.getElementById('addr-zip').value, 
                phone: document.getElementById('addr-phone').value
            }; 
            try { 
                if (id) {
                    await apiRequest(`/addresses/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(d)
                    });
                } else {
                    await apiRequest('/addresses', {
                        method: 'POST',
                        body: JSON.stringify(d)
                    });
                }
                // Reload addresses
                const addresses = await apiRequest('/addresses');
                userAddresses = addresses;
                renderAddressList();
                renderCheckoutAddresses();
                closeAddressForm(); 
                alertMessage("Saved", "success"); 
            } catch(e) {
                console.error(e);
                alertMessage("Failed to save address", "error");
            }
        }
        async function deleteAddress(id) { 
            if(confirm("Delete?")) {
                try {
                    await apiRequest(`/addresses/${id}`, { method: 'DELETE' });
                    // Reload addresses
                    const addresses = await apiRequest('/addresses');
                    userAddresses = addresses;
                    renderAddressList();
                    renderCheckoutAddresses();
                    alertMessage("Address deleted", "success");
                } catch (error) {
                    console.error(error);
                    alertMessage("Failed to delete address", "error");
                }
            }
        }
        function renderAddressList() { const c=document.getElementById('address-list-container'); if(!c)return; c.innerHTML=userAddresses.length?userAddresses.map(a=>`<div class="border border-gray-100 rounded-xl p-4 bg-gray-50 shadow-sm flex justify-between"><div><p class="font-bold text-primary">${a.name}</p><p class="text-xs text-gray-600">${a.street}, ${a.city}</p></div><div class="flex space-x-2"><button onclick="openAddressForm('${a.id}')" class="text-gray-500"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button onclick="deleteAddress('${a.id}')" class="text-red-400"><i data-lucide="trash" class="w-4 h-4"></i></button></div></div>`).join(''):'<p class="text-center text-gray-400 text-sm">No addresses.</p>'; lucide.createIcons(); }
        function renderCheckoutAddresses() { 
            const c=document.getElementById('checkout-address-list'); 
            if(!c)return; 
            c.innerHTML=userAddresses.length?userAddresses.map(a=>`
                <label class="flex items-start p-4 border-2 ${selectedAddressId===a.id?'border-accent bg-accent/5 ring-2 ring-accent/20':'border-gray-200'} rounded-xl cursor-pointer hover:border-accent/50 transition-all duration-300 active:scale-[0.98] ${selectedAddressId===a.id?'shadow-md':''}">
                    <input type="radio" name="checkout_addr" value="${a.id}" class="mt-1 mr-3 accent-accent w-5 h-5" onchange="selectedAddressId='${a.id}'; renderCheckoutAddresses();" ${selectedAddressId===a.id?'checked':''}>
                    <div class="flex-1">
                        <p class="font-bold text-sm text-primary mb-1">${a.name}</p>
                        <p class="text-xs text-gray-600 leading-relaxed">${a.street}, ${a.city}, ${a.zip}</p>
                        <p class="text-xs text-gray-500 mt-1">${a.phone}</p>
                    </div>
                    ${selectedAddressId===a.id ? '<i data-lucide="check-circle" class="w-5 h-5 text-accent ml-2 flex-shrink-0"></i>' : ''}
                </label>
            `).join(''):'<div class="text-center py-6"><i data-lucide="map-pin" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i><p class="text-sm text-gray-500 mb-4">No addresses found</p><button onclick="openAddressForm()" class="px-6 py-2.5 bg-primary text-white rounded-lg text-sm font-bold hover:bg-accent transition-all duration-300">Add Address</button></div>'; 
            if(!selectedAddressId&&userAddresses.length) selectedAddressId=userAddresses[0].id; 
            lucide.createIcons();
        }
        function showReceiptFromOrderId(orderId) {
            const order = userOrders.find(o => o.id === orderId);
            if (order) showReceipt(order);
        }
        function renderOrdersList() { const c=document.getElementById('orders-list-container'); if(!c)return; c.innerHTML=userOrders.length?userOrders.map(o=>`<div class="border border-gray-100 rounded-xl p-4 bg-white shadow-sm mb-3"><div class="flex justify-between mb-2"><span class="font-bold text-sm">#${o.id.slice(0,6).toUpperCase()}</span><span class="text-[10px] px-2 py-0.5 bg-gray-50 rounded-full font-bold">${o.status}</span></div><div class="flex justify-between text-xs text-gray-500 mb-3"><span>${o.date.split(',')[0]}</span><span class="font-bold text-primary">${formatCurrency(o.total)}</span></div><div class="grid ${o.status!=='Cancelled'&&o.status!=='Delivered'?'grid-cols-2':'grid-cols-1'} gap-2"><button onclick="showReceiptFromOrderId('${o.id}')" class="text-xs border border-accent text-accent py-2 rounded-lg font-medium hover:bg-accent hover:text-white transition">Show Receipt</button>${o.status!=='Cancelled'&&o.status!=='Delivered'?`<button onclick="cancelOrder('${o.id}')" class="text-xs border border-red-100 text-red-500 py-2 rounded-lg font-medium hover:bg-red-50 transition">Cancel</button>`:''}</div></div>`).join(''):'<p class="text-center text-gray-400 text-sm">No orders.</p>'; }
        async function cancelOrder(id) { 
            if(confirm("Cancel?")) {
                try {
                    await apiRequest(`/orders/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'Cancelled' })
                    });
                    // Reload orders
                    const orders = await apiRequest('/orders');
                    userOrders = orders;
                    renderOrdersList();
                    alertMessage("Cancelled","success");
                } catch (error) {
                    console.error(error);
                    alertMessage("Failed to cancel order", "error");
                }
            }
        }
        function showReceipt(orderData) {
            const modal = document.getElementById('bill-modal');
            const content = document.getElementById('bill-content');
            
            const orderId = orderData.id ? orderData.id.slice(0, 8).toUpperCase() : 'N/A';
            const date = orderData.date || new Date().toLocaleString();
            const subtotal = orderData.subtotal || cartItems.reduce((s, i) => s + (i.price * i.quantity), 0);
            const discount = orderData.discount || (subtotal * (1 - discountMultiplier));
            const total = orderData.total || (subtotal * discountMultiplier);
            const paymentMethod = orderData.payment || 'N/A';
            const address = orderData.address || {};
            const items = orderData.items || cartItems;
            const status = orderData.status || 'Processing';
            
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center pb-4 border-b border-gray-200">
                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Order ID</p>
                            <p class="text-lg font-bold text-primary">#${orderId}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Status</p>
                            <span class="text-xs px-3 py-1 bg-green-50 text-green-600 rounded-full font-bold">${status}</span>
                        </div>
                    </div>
                    
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wider mb-3">Order Date</p>
                        <p class="text-sm font-medium text-gray-800">${date}</p>
                    </div>
                    
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wider mb-3">Delivery Address</p>
                        <div class="text-sm text-gray-800">
                            <p class="font-bold">${address.name || 'N/A'}</p>
                            <p class="text-gray-600">${address.street || ''}</p>
                            <p class="text-gray-600">${address.city || ''}, ${address.zip || ''}</p>
                            <p class="text-gray-600 mt-1">Phone: ${address.phone || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wider mb-3">Items Ordered</p>
                        <div class="space-y-3">
                            ${items.map(item => `
                                <div class="flex justify-between items-start pb-3 border-b border-gray-100 last:border-0">
                                    <div class="flex-1">
                                        <p class="text-sm font-bold text-gray-900">${item.name}</p>
                                        <p class="text-xs text-gray-500 mt-1">Qty: ${item.quantity} × ${formatCurrency(item.price)}</p>
                                    </div>
                                    <p class="text-sm font-bold text-primary ml-4">${formatCurrency(item.price * item.quantity)}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t-2 border-gray-200 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Subtotal</span>
                            <span class="font-medium text-gray-800">${formatCurrency(subtotal)}</span>
                        </div>
                        ${discount > 0 ? `
                        <div class="flex justify-between text-sm">
                            <span class="text-green-600">Discount</span>
                            <span class="font-medium text-green-600">-${formatCurrency(discount)}</span>
                        </div>
                        ` : ''}
                        <div class="flex justify-between text-lg font-bold pt-2 border-t border-gray-200">
                            <span class="text-primary">Total</span>
                            <span class="text-accent">${formatCurrency(total)}</span>
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t border-gray-200">
                        <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">Payment Method</p>
                        <p class="text-sm font-medium text-gray-800">${paymentMethod}</p>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-4 mt-6">
                        <p class="text-xs text-center text-gray-500">Thank you for your order! We'll process it shortly.</p>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            lucide.createIcons();
        } 

        // Scroll to Top Button
        const scrollToTopBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) {
                scrollToTopBtn.classList.remove('opacity-0', 'pointer-events-none');
                scrollToTopBtn.classList.add('opacity-100', 'pointer-events-auto');
            } else {
                scrollToTopBtn.classList.add('opacity-0', 'pointer-events-none');
                scrollToTopBtn.classList.remove('opacity-100', 'pointer-events-auto');
            }
        });

        document.addEventListener('DOMContentLoaded', () => { 
            filterProducts(); 
            renderCart(); 
            lucide.createIcons();
            
            // Re-initialize icons after footer loads
            setTimeout(() => lucide.createIcons(), 100);
        });
    </script>
</body>
</html>